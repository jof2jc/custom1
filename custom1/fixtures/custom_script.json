[
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Data Import", 
  "modified": "2018-04-21 18:55:49.261018", 
  "name": "Data Import-Client", 
  "script": "frappe.ui.form.on(\"Data Import\", \"refresh\", function(frm, cdt, cdn) {\n\tfrm.remove_custom_button(('Help'));\n\tfrm.remove_custom_button(('Download template'));\n\tif (!frappe.user.has_role(\"Administrator\",\"System Manager\")){\n\t\tfrm.clear_custom_buttons();\n\t\tfrm.set_df_property(\"reference_doctype\",\"read_only\",1);\n\t\tfrm.set_df_property(\"submit_after_import\",\"read_only\",1);\n\t}\n\telse {\n\t\tfrm.set_df_property(\"reference_doctype\",\"read_only\",0);\n\t\tfrm.set_df_property(\"submit_after_import\",\"read_only\",0);\n\t}\n\t//\tfrm.clear_custom_button(__(\"Help\"), function() {\n\t\t\t//frappe.help.show_video(\"6wiriRKPhmg\");\n\t//\t});\n});\n", 
  "script_type": "Client"
 }, 
 {
  "docstatus": 0, 
  "doctype": "Custom Script", 
  "dt": "Payment Entry", 
  "modified": "2018-05-06 19:07:00.102666", 
  "name": "Payment Entry-Client", 
  "script": "frappe.ui.form.on(\"Payment Entry\", \"validate\", function(frm, cdt, cdn) {\n\tvar total_outstanding = 0;\n\t$.each(frm.doc.references || [], function(i, r){\n\t\ttotal_outstanding += r.ordered_amount || r.outstanding_amount;\t\n\t\tif (r.ordered_amount != 0 && r.ordered_amount != r.total_amount && r.reference_doctype == \"Sales Invoice\" && frm.doc.payment_type == \"Receive\" && frm.doc.online_order_ids){\n\t\t\tfrappe.msgprint(__(\"Row \" + r.idx + \". Difference amount found : \" + Number(r.ordered_amount - r.total_amount).toLocaleString()));\n\t\t\t$('div[data-fieldname=\"references\"]').find(format('div.grid-row[data-idx=\"{0}\"]', [r.idx])).css('background','#FDEDEC')\n\t\t\t//frappe.validated = false;\n\t\t\t//return;\n\t\t}\n\t});\n\tconsole.log('total_outstanding == ' + total_outstanding);\n\tif (frm.doc.online_order_ids){\n\t\tfrm.set_value(\"paid_amount\", total_outstanding);\n\t\tfrm.script_manager.trigger(\"paid_amount\");\n\t\tfrm.set_value(\"allocate_payment_amount\", 1);\n\t}\n});\nfrappe.ui.form.on(\"Payment Entry\", \"online_order_ids\", function(frm, cdt, cdn) {\n\tfrm.doc.references = [];\n});\nfunction escapeRegExp(str) {\n    return str.replace(/([.*+?^=!:${}()|\\[\\]\\/\\\\])/g, \"\\\\$1\");\n}\nfunction replaceAll(str, find, replace) {\n    return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);\n}\nfunction nth_occurrence (string, char, nth) {\n    var first_index = string.indexOf(char);\n    var length_up_to_first_index = first_index + 1;\n\n    if (nth == 1) {\n        return first_index;\n    } else {\n        var string_after_first_occurrence = string.slice(length_up_to_first_index);\n        var next_occurrence = nth_occurrence(string_after_first_occurrence, char, nth - 1);\n\n        if (next_occurrence === -1) {\n            return -1;\n        } else {\n            return length_up_to_first_index + next_occurrence;  \n        }\n    }\n}\n\nfrappe.ui.form.on(\"Payment Entry\", \"get_invoices\", function(frm, cdt, cdn) {\n    var total_outstanding = 0;\n    console.log('executing get invoices..');\n    if(frm.doc.docstatus < 1 && frm.doc.party_type == \"Customer\" && frm.doc.party){\n\tif (!frm.doc.online_order_ids){\n\t\tfrm.set_value(\"online_order_ids\", frm.doc.online_order_ids.trim() + \"\\n\");\n\t\tfrm.doc.references = [];\n\t}\n\tvar order_ids = frm.doc.online_order_ids.trim().split(\"\\n\");\t\n\tvar arr_id = []; var arr_amount = [];\n\tvar obj_id = {};\n\tvar str;\n\tvar ordered_amount = 0;\t\n\t//console.log('online_order_ids='+order_ids);\t\n\n\t$.each(order_ids || [], function(i, r){\n\t\tvar order_id = \"\";\n\n\t\t//get mutation amount and convert to float\n\t\tvar curr_idx = nth_occurrence(r, 'Rp', 1); //tokopedia\n\t\tconsole.log('curr_idx === ' + curr_idx);\n\t\t//console.log('get amount string === ' + r.substring(0,r.length).replace(\".\",\"\"));\n\t\tif (curr_idx >= 0 || !isNaN(parseFloat(r.substring(0,r.length).replace(\".\",\"\")))){\n\t\t\tvar str = r.substring(curr_idx,r.length); //tokped\n\t\t\t//bukalapak\n\t\t\tif (r.indexOf('#') > 0){ //bukalapak)\n\t\t\t\torder_id = r.substring(r.indexOf('#')+1,r.trim().length); //bukalapak\n\t\t\t\tif (arr_id.length == 0)arr_id.push(order_id);\n\t\t\t}\n\t\t\tif (nth_occurrence(r, 'Rp', 2) >= 0)str = r.substring(curr_idx,nth_occurrence(r, 'Rp', 2)-1);\n\t\t\tstr = replaceAll(str,\".\",\"\");\n\t\t\tstr = str.replace(\",\",\".\");\n\t\t\tstr = str.replace(\"Rp\",\"\");\t\t\n\t\t\t//var _amount = parseFloat(str.replace(/[^0-9\\.-]+/g,\"\"));\n\t\t\tvar _amount = parseFloat(str.trim());\n\t\t\t//console.log('str === ' + str);\n\t\t\tconsole.log('_amount === ' + _amount);\n\t\t\tif (!isNaN(_amount) && (arr_id.length >= 2))arr_id=[];\n\t\t\tif (arr_id.length == 1 && !isNaN(_amount) && !isNaN(str.trim())){ \n\t\t\t\tarr_id.push(_amount); obj_id[arr_id[0]] = _amount;\n\t\t\t\tarr_amount.push(obj_id); \t\t\t\t \n\t\t\t}\n\t\t\tconsole.log('arr_id == ' + arr_id);\n\t\t\t//console.log('arr_amount 55 == ' + arr_amount[0]['INV/20171204/XVII/XII/120055955']);\n\t\t\t//console.log('arr_amount 56 == ' + arr_amount[0]['INV/20171204/XVII/XII/120055956']);\n\t\t}\t\t\n\n\t\torder_id = r.substring(r.indexOf('INV/'),r.trim().length); //tokopedia\n\t\tif (r.indexOf('INV/') < 0) order_id = r.substring(r.indexOf('#')+1,r.trim().length); //bukalapak\n\t\tconsole.log('order_id == '+ order_id);\n\t\t//console.log('indexOf INV == '+ r.indexOf('INV/'));\n\t\t//console.log('indexOf # == '+ r.indexOf('#'));\n\t\tif (r.indexOf('INV/') < 0 && r.indexOf('#') < 0){\n\t\t\tvar shopee_id = parseFloat(r.trim().substring(0,10));\n\t\t\tconsole.log('shopee here == ' + shopee_id);\n\t\t\t//console.log('shopee_id.length == ' + shopee_id.toString().length);\n\t\t\tif (!isNaN(shopee_id) && shopee_id.toString().length == 10){\n\t\t\t\torder_id = r.substring(0,15)\n\t\t\t\tconsole.log('shopee_id == ' + order_id);\n\t\t\t\tif (order_id.length < 15)return;\n\t\t\t}\n\t\t\telse { return; }// goto next loop\n\t\t}\n\t\tif (arr_id.length == 0 && order_id.length >=12)arr_id.push(order_id);\n\t\tconsole.log('arr_id.length == ' + arr_id.length);\n\t\tif (arr_id.length >= 2)arr_id=[];\n\n\t\t//if (frm.doc.references.length >=1){\n\t\t\trow = frm.doc.references.find(function(obj){ \n\t\t\t\treturn obj.reference_name.indexOf(order_id) > -1; \n\t\t\t});\n\t\t//}\n\t\tconsole.log('existing reference_name == '+ row);\n\t\tif (arr_id.length ==2)ordered_amount = arr_id[1];\t\n\t\tif ((!row || row == undefined)){\t\t\n\t\t\t//console.log('arr_id 22 == ' + arr_id);\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"custom1.custom1.custom1.an_get_invoice_by_orderid\", \n\t\t\t\targs: {\n\t\t\t\t\t\"order_id\" : order_id,\n\t\t\t\t\t\"customer\" : frm.doc.party\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\t//console.log('arr_id 33 == ' + arr_id);\n\t\t\t\t\tif(!r.exc && r.message){\n\t\t\t\t\t\trow = frm.doc.references.find(function(obj){ \n\t\t\t\t\t\t\treturn obj.reference_name.indexOf(order_id) > -1; \n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (row) return;\n\t\t\t\t\t\tconsole.log('success get invoice == ' + r.message[0][0]);\n\t\t\t\t\t\tconsole.log('add new row..');\n\t\t\t\t\t\trow = frm.add_child(\"references\");\n\t\t\t\t\t\trow.reference_doctype = \"Sales Invoice\";\n\t\t\t\t\t\tfrappe.model.set_value(row.doctype, row.name, \"reference_name\",r.message[0][0]); row.allocated_amount = r.message[0][1];\n\t\t\t\t\t\tobj_amount = arr_amount.find(function(obj){ \n\t\t\t\t\t\t\tif (r.message[0][0].indexOf(order_id) > -1){\n\t\t\t\t\t\t\t\treturn obj; \n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\t\t\t\t\t\n\t\t\t\t\t\tif (obj_amount)console.log('obj_amount == ' + obj_amount[order_id]);\n\t\t\t\t\t\tif (obj_amount) row.ordered_amount = obj_amount[order_id];\n\t\t\t\t\t\t\n\t\t\t\t\t\ttotal_outstanding += r.message[0][1];\n\t\t\t\t\t\t//arr_id = [];\n\t\t\t\t\t\t//console.log('arr_id after inserting new row == ' + arr_id);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\trefresh_field(\"references\");\n\t\t//console.log('frm.doc.references == ' + frm.doc.references);\n\t\t//console.log('total_outstanding == ' + total_outstanding);\n\t\t//frm.set_value(\"paid_amount\", total_outstanding);\n\t});\n    }\n});\n", 
  "script_type": "Client"
 }
]