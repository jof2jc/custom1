[
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Sales Invoice",
  "modified": "2020-05-15 10:46:40.559531",
  "name": "Sales Invoice-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Sales Invoice\", \"onload\", function(frm, cdt, cdn) {\n\t//if (frappe.user.has_role(\"System Manager\")){\n\tif (frm.doc.docstatus < 1 && frm.doc.is_return && frm.is_new()){\n\t\tconsole.log('onload new is_return');\n\t\tconsole.log('order_status === ' + frm.doc.order_status);\n\t\t//console.log(frappe.get_list('Sales Invoice','181095347142-01'));\n\t\t\n\t\t$.each(frm.doc.items, function(i, r){ \n\t\t       if (frm.is_new() && r)frm.script_manager.trigger(\"uom\",r.doctype, r.name);\n\t\t});\n\t\t//$(frm.fields_dict.awb_barcode.wrapper).html(\"<script>JsBarcode('.mybarcode').init();\");\n\t}\t\t\n});\nfrappe.ui.form.on('Sales Invoice', \"refresh\", function(frm, cdt, cdn) {\n\tvar me = this;\n\tif (frm.doc.docstatus < 1){\n\t\tfrm.fields_dict['sales_person'].get_query = function(doc, cdt, cdn) {\n\t\t       return {\n\t        \t       filters:{\n                \t      \t\t\"is_group\":[\"=\", 0],\n\t\t\t\t\t\"enabled\":[\"=\", 1]\n\t\t\t\t}\n               \t\t}\n\t\t}\n\t}\n});\n\nfrappe.ui.form.on('Sales Invoice', \"marketplace_courier\", function(frm, cdt, cdn) {\n\tvar me = this;\n\tif (frm.doc.docstatus < 1){\n\t    frappe.db.get_value(\"Marketplace Courier\", {\"name\":frm.doc.marketplace_courier}, [\"name\",\"courier_name\",\"courier_type\"], function(value){ \n\t        if(value){\n\t            frm.set_value(\"courier\",value.courier_name);    \n\t            frm.set_value(\"courier_type\",value.courier_type);\n\t        }\n\t    });        \n\t}\n});\n\nfrappe.ui.form.on(\"Sales Invoice\", \"validate\", function(frm, cdt, cdn) {\n    var d = locals[cdt][cdn];\n    var cust_group = \"\";\n    //msgprint(frm.docstatus);\n    if(frm.doc.docstatus < 1){\t\n\t\tif (!frappe.user.has_role(\"Accounts Manager\") && frm.doc.is_return){\n\t\t\tfrappe.validated = false;\n\t\t\tfrappe.throw(\"Not Allowed. Please check with your manager\");\n\t\t\treturn;\n\t\t}\n\t\tif (frm.doc.is_return){\n\t\t\tif (frappe.session.user.indexOf('sby') > -1)frm.doc.naming_series=\"R-SBY/.YY./.MM./.###\";\n\t\t\telse frm.set_value(\"naming_series\", \"R/INV/.YY./.MM./.###\");\n\t\t}\n\t\telse {\n\t\t\tif (frappe.session.user.indexOf('sby') > -1)frm.doc.naming_series=\"SBY/.YY./.MM./.###\";\n\t\t\telse frm.set_value(\"naming_series\", \"INV/.YY./.MM./.###\");\n\t\t}\n\n\t\tif (frm.doc.no_online_order && frm.doc.no_online_order.length > 10){\n\t\t\tif (frm.doc.is_return)frm.set_value(\"naming_series\", \"R/.no_online_order.-.##\");\n\t\t\telse frm.set_value(\"naming_series\", \"no_online_order.-.##\");\n\t\t}\n\t\t$.each(frm.doc.items, function(i, r){ \t\n\t\t\tif (!r.rate){\n\t\t\t\tfrappe.throw(\"Row \" + r.idx + \". Rate is required\");\n\t\t\t\tfrappe.validated = false;return;\n\t\t\t}\n\t\t\tif (frappe.session.user.indexOf('sby') > -1)r.cost_center=\"Surabaya - bom\";\n\n\t\t\tfrappe.call({\n\t\t\tmethod: \"erpnext.stock.utils.get_incoming_rate\", \n\t\t\targs: {\n\t\t\t\targs: {\n\t\t\t\t\t\"item_code\": r.item_code, \n\t\t\t\t\t\"warehouse\": r.warehouse,\n\t\t\t\t\t\"posting_date\": frm.doc.posting_date,\n\t\t\t\t\t\"posting_time\": frm.doc.posting_time\n\t\t\t\t}\n\t\t\t},\n\t\t\tcallback: function(v){\n\t\t\t\tconsole.log('incoming rate====' + v.message);\n\t\t\t\tconsole.log('r rate====' + r.rate);\n\t\t\t\tif (r.message && (r.message > v.rate) && !frappe.user.has_role(\"Accounts Manager\")){\n\t\t\t\t\tfrappe.throw(\"Row \" + r.idx + \". Selling rate is under valuation rate\");\n\t\t\t\t\tfrappe.validated = false;return;\n\t\t\t\t}\n\t\t\t}\n\t\t\t});\n\t\t})\n\t\t/*\n\t\t$.each(frm.doc.taxes, function(i, r){ //update cost center\n\t\t\tif (cust_group == \"Retail\"){\n\t\t\t\tr.cost_center = \"Retail - IMP\";\t\n\t\t\t}else if (cust_group == \"Corporate\"){\n\t\t\t\tr.cost_center = \"Corporate - IMP\";\n\t\t\t}else if (cust_group == \"Gudang Grosir\"){\n\t\t\t\tr.cost_center = \"Gudang Grosir - IMP\";\n\t\t\t}\n\t\t\tif (frm.doc.no_online_order && frm.doc.no_online_order.length > 5){\n\t\t\t\tr.cost_center = \"Online - IMP\";\n\t\t\t}\t\n\t\t});\n\t\t*/\n\t\tif (frm.doc.sales_person)frm.doc.title = frm.doc.sales_person + \"/\" + frm.doc.customer;\n\n\t\tif(frm.doc.sales_person){\n\t\t\tfrm.doc.sales_team = [];\n\t\t\tvar row = frm.add_child('sales_team');\n\t\t\tfrappe.model.set_value(row.doctype,row.name, \"sales_person\", frm.doc.sales_person);\n\t\t\trow.allocated_percentage = 100;\n\t\t}\n    }\t\n  //msgprint(item_code);\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Stock Entry",
  "modified": "2020-07-09 13:12:24.402281",
  "name": "Stock Entry-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Stock Entry Detail\", \"basic_rate\", function(frm, cdt, cdn) {\n    var d = locals[cdt][cdn];\n \t \n  // frm.refresh();\n  // msgprint(d.expense_account);\n});\n\nfrappe.ui.form.on(\"Stock Entry\", \"validate\", function(frm, cdt, cdn) {\n\tvar d = locals[cdt][cdn];\n\tif (frappe.session.user.indexOf('sby') > -1)frm.doc.naming_series=\"SBY-STE/.YY./.MM./.###\";\n\n\tif(frm.doc.docstatus < 1){\n\t\t$.each(frm.doc.items, function(i, r){ \n\t\t\t//r.expense_account = \"Capital Stock - TBPR\";\n\t\t\tif (frappe.session.user.indexOf('sby') > -1)r.cost_center=\"Surabaya - bom\";\n\t\t\t\n\t\t\tif (frappe.session.user.indexOf('sby') > -1){\n\t\t\t\tif(frm.doc.purpose == \"Material Receipt\"){\n\t\t\t\t\tif (r.t_warehouse.indexOf('Surabaya') < 0){\n\t\t\t\t\t\tfrappe.throw(\"You cannot receipt items into \" + r.t_warehouse);\n\t\t\t\t\t\tfrappe.validated = false;\n\t\t\t\t\t}\n\t\t\t\t}else if (frm.doc.purpose == \"Material Issue\" || frm.doc.purpose == \"Material Transfer\"){\n\t\t\t\t\tif (r.s_warehouse.indexOf('Surabaya') < 0){\n\t\t\t\t\t\tfrappe.throw(\"You cannot issue/transfer items from \" + r.s_warehouse);\tfrappe.validated = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (frappe.session.user.indexOf('sby') < 0 && !frappe.user.has_role(\"Accounts Manager\")){\n\t\t\t\tif(frm.doc.purpose == \"Material Receipt\"){\n\t\t\t\t\tif (r.t_warehouse.indexOf('Surabaya') > -1){\n\t\t\t\t\t\tfrappe.throw(\"You cannot receipt items into \" + r.t_warehouse);\n\t\t\t\t\t\tfrappe.validated = false;\n\t\t\t\t\t}\n\t\t\t\t}else if (frm.doc.purpose == \"Material Issue\" || frm.doc.purpose == \"Material Transfer\"){\n\t\t\t\t\tif (r.s_warehouse.indexOf('Surabaya') > -1){\n\t\t\t\t\t\tfrappe.throw(\"You cannot issue/transfer items from \" + r.s_warehouse);\tfrappe.validated = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\t  \n\t}\n});\nfrappe.ui.form.on(\"Stock Entry\", \"purpose\", function(frm, cdt, cdn) {\n\t//frm.refresh();\n});\n"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Purchase Invoice",
  "modified": "2020-05-12 19:17:40.324350",
  "name": "Purchase Invoice-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Purchase Invoice\", \"onload\", function(frm, cdt, cdn) {\n\tif (frm.doc.docstatus < 1 && frm.doc.is_return && frm.is_new()){\n\t\tconsole.log('onload is_return');\n\t\tfrm.trigger(\"buying_price_list\");\n\t}\n});\nfrappe.ui.form.on(\"Purchase Invoice\", \"onload_post_render\", function(frm, cdt, cdn) {\n\tif (frm.doc.docstatus < 1 && frm.doc.is_return && frm.is_new()){\n\t\tconsole.log('onload post render is_return');\n\t\t//frm.trigger(\"buying_price_list\");\n\t\t$.each(frm.doc.items, function(i, r){ \n\t\t       if (frm.doc.is_return && frm.is_new() && r){\n\t\t           frappe.call({\n\t\t\t            method: \"erpnext.stock.utils.get_incoming_rate\", \n\t\t\t            args: {\n\t\t\t\t            args: {\n\t\t\t\t\t            \"item_code\": r.item_code, \n\t\t\t\t\t            \"warehouse\": r.warehouse,\n\t\t\t\t\t            \"posting_date\": frm.doc.posting_date,\n\t\t\t\t\t            \"posting_time\": frm.doc.posting_time\n\t\t\t\t            }\n\t\t\t            },\n\t\t\t            callback: function(v){\n\t\t\t\t            console.log('incoming rate====' + v.message);\n\t\t\t\t            if (v.message){\n\t\t\t\t\t           if (!r.rate) frappe.model.set_value(r.doctype, r.name, \"rate\", v.message);\n\t\t\t\t\t            console.log('r rate====' + r.rate);\n\t\t\t\t\t            frm.script_manager.trigger(\"uom\",r.doctype, r.name);\n\t\t\t\t            } else frm.script_manager.trigger(\"price_list_rate\",r.doctype, r.name);\n\t\t\t            }\n\t\t\t       });\n\t\t       }\n\t\t});\n\t}\t\t\n});\nfrappe.ui.form.on(\"Purchase Invoice\", \"validate\", function(frm, cdt, cdn) {\n    var d = locals[cdt][cdn];\n    //msgprint(frm.docstatus);\n\n    if(frm.doc.docstatus < 1){\t\t\n\t\n\tif (frm.doc.is_return){\n\t\tif (frappe.session.user.indexOf('sby') > -1)frm.doc.naming_series=\"R-SBY-PI/.YY./.MM./.###\";\n\t\telse frm.set_value(\"naming_series\", \"R/PI/.YY./.MM./.###\");\n\t}\n\telse {\n\t\tif (frappe.session.user.indexOf('sby') > -1)frm.doc.naming_series=\"SBY-PI/.YY./.MM./.###\";\n\t\telse frm.set_value(\"naming_series\", \"PI/.YY./.MM./.###\");\n\t}\n\t\t\n\t$.each(frm.doc.items, function(i, r){ \n\t\tif (frappe.session.user.indexOf('sby') > -1)r.cost_center=\"Surabaya - bom\";\n   \t });\t\n\t$.each(frm.doc.taxes, function(i, r){ \n\t\tif (frappe.session.user.indexOf('sby') > -1)r.cost_center=\"Surabaya - bom\";\n   \t });\n    }\n  //msgprint(item_code);\n});\nfrappe.ui.form.on(\"Purchase Invoice\", \"supplier\", function(frm, cdt, cdn) {\n    if (frm.doc.docstatus < 1){\n\tfrappe.after_ajax(function(){\n\t         frm.set_value(\"due_date\",frappe.datetime.add_days(frm.doc.posting_date, 30));\n\t});\n    }\n});\nfrappe.ui.form.on(\"Purchase Invoice\", \"is_paid\", function(frm, cdt, cdn) {\n    if (!frm.doc.is_paid){\n         frm.set_df_property(\"due_date\", \"hidden\", false);\n    }\n});\nfrappe.ui.form.on(\"Purchase Invoice\", \"is_return\", function(frm, cdt, cdn) {\n \tif (frm.doc.is_return)frm.set_value(\"naming_series\", \"R/PI/.YY./.MM./.###\");\n\telse frm.set_value(\"naming_series\", \"PI/.YY./.MM./.###\");\n\t\n   //refresh_fields(\"naming_series\");\n    \n});\n\n\n/*\nfrappe.ui.form.on(\"Purchase Invoice\", \"refresh\", function(frm, cdt, cdn) {\n    var d = locals[cdt][cdn];\n    if(frm.doc.docstatus < 1){\n    \t$.each(frm.doc.items, function (i, r) \n\t\t{\n\t\t\tconsole.log(r.warehouse);\n\t\t\tif (r.warehouse == \"Pasar 8 Alam Sutera - mm\"){\n        \t\t\t r.cost_center = \"Pasar 8 Alam Sutera- amd\";\n    \t\t\t}\n    \t\t\telse {\n\t\t\t         r.cost_center = \"General - mm\";\n    \t\t\t}\n\t\t\t//frappe.model.set_value(cdt, cdn, \"cost_center\", frm.doc.cost_center);\n\t\t\t//r.cost_center = frm.doc.cost_center;\n\t\t\tconsole.log(r.cost_center);\n\t\t})\n\t\t//refresh_field(\"items\");\n\t}\n});\n*/"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Stock Reconciliation",
  "modified": "2019-12-19 18:19:07.888016",
  "name": "Stock Reconciliation-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Stock Reconciliation\", \"validate\", function(frm, cdt, cdn) {\n    var d = locals[cdt][cdn];\n    //msgprint(frm.docstatus);\n    if(frm.doc.docstatus < 1){\n\t\n\t\tfrm.set_value(\"expense_account\", \"Capital Stock - bom\");\n\t}\n\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Item",
  "modified": "2020-05-01 10:51:49.804394",
  "name": "Item-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Item\", \"after_save\", function(frm, cdt, cdn) {\n    console.log('pong event');\n});\nfrappe.ui.form.on(\"Item\", \"refresh\", function(frm, cdt, cdn) {\n    //frm.web_link.remove();\n\t//cur_frm.dashboard.frm.fields[0].df.hidden=1;\n\t//this.frm.collapse();\n\t//this.sections[0].df.collapsible=0;\n\t//frm.save('Submit');\n\tconsole.log(frm.dashboard.frm.fields[0].df.collapsible);\n\tconsole.log(frappe.get_doc('Item', 'PRN17AB'));\n\tconsole.log(frappe.model.get_doc('Sales Invoice','181095347142-01'));\n\tfrappe.call('ping')\n\t\t.then(r => {\n        \t\tconsole.log('pong 1');\n\t\t})\n\t\t.then(r => {\n        \t\tconsole.log('pong 2');\n\t\t})\n\tfrappe.db.get_value('Item', 'PRN17AB','item_name')\n    \t\t.then(doc => {\n\t\t        console.log(doc.message)\n    \t\t})\n});\n\nfrappe.ui.form.on(\"Item\", \"onload\", function(frm, cdt, cdn) {\nfunction hello(callback){\n    setTimeout(function(){\n        console.log('hello');\n\tcallback();\n    },5);\n\tconsole.log('after set timer');\n}\t\nfunction world(){\n    console.log(\"world\");\n}\nhello(world);\n//world();\n});\n/*\nfrappe.ui.form.on(\"Item\", \"validate\", function(frm, cdt, cdn) {\n\tif(!frm.doc._islocal){\n\t\tconsole.log('hey');\n\t\tif (frm.doc.item_code != \"\"){\n\t\t//\tfrm.set_value(\"item_code\", frm.doc.item_code+=\":\"+frm.doc.stock_uom);\n\t\t}\n\t\t\n\t}\n\t\n});\n*/\n\n/*\nfrappe.ui.form.on(\"Item\", \"onload\", function(frm, cdt, cdn) {\n\t//if(frm.doc._islocal){\n\t\tconsole.log('hey');\n\t\tif (frm.doc.item_name != frm.doc.item_code || frm.doc.description != frm.doc.item_name){\n\t\t\tfrm.set_value(\"item_name\", frm.doc.item_code);\n\t\t\tfrm.set_value(\"description\", frm.doc.item_code);\n\t\t\tfrm.save();\n\t\t}\n\t\t\n\t//}\n\t\n});\n*/"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Delivery Note",
  "modified": "2018-01-04 23:08:02.446263",
  "name": "Delivery Note-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Delivery Note\", \"validate\", function(frm, cdt, cdn) {\n\tif(frm.doc.docstatus < 1){\n\t\tvar d = new Date();\n\t\tvar t = d.getHours() + ':' + d.getMinutes() + ':' + d.getSeconds(); \n\n\t\tif (!frm.doc._islocal)frm.set_value(\"posting_time\", t.toString());\n\n\t\tif (frm.doc.is_return) frm.set_value(\"naming_series\", \"R/DLN/.YY./.MM./.###\");\n\t}\n\t\n});\n\nfrappe.ui.form.on(\"Delivery Note\", \"is_return\", function(frm, cdt, cdn) {\n \tif (frm.doc.is_return){\n\t\tfrm.set_value(\"naming_series\", \"R/DLN/.YY./.MM./.###\");\t\t\n\t}\n\n   //refresh_fields(\"naming_series\");\n    \n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Data Import Legacy",
  "modified": "2020-08-01 12:47:49.502036",
  "name": "Data Import-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "\nfrappe.ui.form.on(\"Data Import Legacy\", {\n    refresh: function(frm) {\n        frm.dashboard.wrapper.parent().removeClass(\"hide\")\n            .parent().find(\".section-head\").removeClass(\"collapsed\")\n            .find(\".octicon.collapse-indicator.octicon-chevron-up\")\n            .removeClass()\n            .addClass(\"octicon collapse-indicator octicon-chevron-down\") \n    },\n    onload: function(frm) {\n        frm.set_value(\"reference_doctype\",\"Sales Invoice\");  \n        frm.set_value(\"action\",\"Insert new records\");  \n        frm.set_value(\"submit_after_import\",0);\n        //if (frm.doc.docstatus >=0)frm.events.show_only_errors(frm);\n    }\n})\n\nfrappe.ui.form.on(\"Data Import Legacy\", \"skip_errors\", function(frm) {\n    //frm.events.show_only_errors(frm);\n});    \nfrappe.ui.form.on(\"Data Import Legacy\", \"show_only_errors\", function(frm, cdt, cdn) {\n\tlet msg = JSON.parse(frm.doc.log_details);\n\tvar error_status1 = [];var error_status2 = [];\n\t//console.log('frm.doc.log_details == ' + frm.doc.log_details);\n\tfor (var i = 0; i < msg.messages.length; i++){\n\t\t//console.log(i);\n\t\t//console.log(msg.messages[i]);\n\t\t\tif (msg.messages[i].message.indexOf('Same Invoice') >=0 || msg.messages[i].message.indexOf('Belum Diproses') >=0 || msg.messages[i].message.indexOf('Pending') >=0 || msg.messages[i].message.indexOf('Qty tidak ada') >=0 || msg.messages[i].message.indexOf('Harga kosong') >=0){\n\t\t\t\terror_status2.push(msg.messages[i]); //msg.messages.splice(i,1);\n\t\t\t} else { //if (msg.messages[i].message.indexOf('success') < 0)\n\t\t\t    console.log('msg.messages[i] = ' + msg.messages[i]);\n\t\t\t\terror_status1.push(msg.messages[i])\n\t\t\t}\n\t}\n\t//let err = JSON.parse(error_status);\n\t//console.log(error_status2);//console.log(err);\n\tvar $log_wrapper = $(frm.fields_dict.import_log.wrapper).empty();\n\t\t$(frappe.render_template(\"log_details\", {data: error_status1, \n\t\t\tshow_only_errors: frm.doc.show_only_errors,//filters: {\"message\": [\"not like\",\"%Code%\"]},\n\t\t\timport_status: frm.doc.import_status})).appendTo($log_wrapper);\n\t\t\t//console.log(msg.messages);\n\tvar $log_wrapper2 = $(frm.fields_dict.import_log2.wrapper).empty();\n\t\t$(frappe.render_template(\"log_details\", {data: error_status2, \n\t\t\tshow_only_errors: frm.doc.show_only_errors,//filters: {\"message\": [\"not like\",\"%Code%\"]},\n\t\t\timport_status: frm.doc.import_status})).appendTo($log_wrapper2);\n\n\tconsole.log('error_status2.length = ' + error_status2.length);\n\tconsole.log('error_status1.length = ' + error_status1.length);\n\t/*if (error_status1.length <=0){ \n\t\tif (frm.doc.docstatus < 1){\n\t\t    console.log('here checking skip_errors');\n\t\t\tfrm.set_value(\"skip_errors\",1);\n\t\t\tfrm.set_df_property(\"skip_errors\",\"read_only\",0);\n\t\t}\n\t}\n\telse{ \n\t\t    if (frm.doc.docstatus < 1){\n\t\t\t    frm.set_value(\"skip_errors\",0);\n\t\t\t    frm.set_df_property(\"skip_errors\",\"read_only\",1);\n\t\t    }\n\t}*/\n});\nfrappe.ui.form.on(\"Data Import Legacy\", \"validate\", function(frm, cdt, cdn) {\n    if (frm.doc.import_file && frm.doc.update_awb){\n        var file = frm.doc.import_file.split('/');\n        if (file) {\n            frm.doc.title = \"Update AWB-\" + file[file.length-1];\n        }\n    }\n});\nfrappe.ui.form.on(\"Data Import Legacy\", \"update_awb\", function(frm, cdt, cdn) {\n    if (!frm.doc.total_rows && frm.doc.update_awb)frm.doc.total_rows=1; //pass validate file format\n    frm.save();\n    //if (frm.doc.total_rows==1 && frm.doc.update_awb)frm.doc.total_rows=0;\n});\nfrappe.ui.form.on(\"Data Import Legacy\", \"refresh\", function(frm, cdt, cdn) {\n    frm.clear_custom_buttons();\n\tconsole.log('total_rows === ' + frm.doc.total_rows);\n\tif (frm.doc.reference_doctype && frm.doc.import_file && !frm.doc.update_awb &&\n\t\t\tfrm.doc.docstatus === 0 && (!frm.doc.import_status || frm.doc.import_status==\"Failed\")) {\n\t\t\tfrm.page.set_primary_action(__(\"Start Marketplace Importer\"), function() {\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"custom1.custom1.marketplace_order_importer.upload_marketplace_order\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\tdata_import: frm.doc.name\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}).addClass('btn btn-primary');\n\t} \n    if (frm.doc.reference_doctype && frm.doc.import_file && frm.doc.update_awb &&\n\t\t\tfrm.doc.docstatus === 0 && (!frm.doc.import_status || frm.doc.import_status==\"Failed\")) {\n\t\t\tfrm.page.set_primary_action(__(\"Start Update AWB\"), function() {\n\t\t\t\tfrappe.call({\n\t\t\t\t\tmethod: \"custom1.custom1.awb_updater.update_awb\",\n\t\t\t\t\targs: {\n\t\t\t\t\t\tdata_import: frm.doc.name\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}).addClass('btn btn-primary');\n\t}\n\n\tfrm.dashboard.frm.fields[0].df.collapsible=0;\n\t//this.sections[0].df.collapsible=0;\n\tfrm.fields_dict['import_detail'].collapse();\n\tif (frm.doc.total_rows && frm.doc.import_status.indexOf('Success') > -1) {\n\t    frm.set_value(\"show_only_errors\",0);\n\t}\n\telse if (frm.doc.total_rows){\n\t    //console.log('here...');\n\t    frm.set_value(\"show_only_errors\",1);\n\t    frm.events.show_only_errors(frm, cdt, cdn);\n\t} \n\t\n\tfrm.remove_custom_button(('Help'));\n\t//frm.remove_custom_button(('Download template'));\n\t\n\tfrm.set_df_property(\"action\",\"read_only\",1);\n\tfrm.set_df_property(\"submit_after_import\",\"hidden\",1);\n\tfrm.set_df_property(\"submit_after_import\",\"read_only\",1);\n\t\n\tif (!frappe.user.has_role(\"Administrator\",\"System Manager\")){\n\t\tfrm.clear_custom_buttons();\n\t\tfrm.set_df_property(\"reference_doctype\",\"read_only\",1);\n\t\tfrm.set_df_property(\"submit_after_import\",\"read_only\",1);\n\t}\n\telse {\n\t\tfrm.set_df_property(\"reference_doctype\",\"read_only\",0);\n\t\tfrm.set_df_property(\"submit_after_import\",\"hidden\",0);\n\t\tfrm.set_df_property(\"submit_after_import\",\"read_only\",0);\n\t}\n\t//\tfrm.clear_custom_button(__(\"Help\"), function() {\n\t\t\t//frappe.help.show_video(\"6wiriRKPhmg\");\n\t//\t});\n\n\tif (!frappe.user.has_role(\"Administrator\",\"System Manager\")){\n\t    frm.set_query(\"reference_doctype\", function(){\n        \treturn {\n\t\t            \"filters\": [\n                \t\t\t[\"name\", \"in\", [\"Sales Invoice\",\"Item\"]]\n            \t\t\t]\n        \t}\n    \t});\n\t}\n});\n"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Payment Entry",
  "modified": "2020-07-06 13:23:01.710869",
  "name": "Payment Entry-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Payment Entry\", \"onload\", function(frm, cdt, cdn) {\n    if (frm.doc.paid_amount != frm.doc.total_allocated_amount) {\n        //console.log('trigger paid_amount...paid_amount != total_allocated_amount')\n\t\tfrm.trigger(\"paid_amount\");\n\t} \n});\nfrappe.ui.form.on(\"Payment Entry\", \"attach_file\", function(frm, cdt, cdn) {\n    if (frm.doc.attach_file && frm.doc.docstatus < 1) {\n\t\t//frm.save();\n\t} else {\n\t    \n\t}\n});\nfrappe.ui.form.on(\"Payment Entry\", \"add_progress_bar\", function(frm) {\n    if (frm.doc.attach_file && frm.doc.docstatus < 1) {\n       console.log(\"add progress bar\");\n\t\tfrm.dashboard.add_progress(\"Payment Entry Progress\", \"0\");\n\t\tfrm.set_read_only();\n\t\tfrm.refresh_fields(); \n\t\t\n\t}\n});\nfrappe.ui.form.on(\"Payment Entry\", \"refresh\", function(frm, cdt, cdn) {\n    frm.set_df_property(\"get_outstanding_invoice\", \"hidden\", frm.doc.attach_file ? true : false);\n    if (frm.doc.attach_file && frm.doc.docstatus < 1 && frm.doc.import_status != \"Success\") {\n       console.log(\"add progress bar 1\");\n\t\tfrm.dashboard.add_progress(\"Payment Entry Progress\", \"0\");\n\t\tif (!frm.doc.import_status)frm.set_read_only();\n\t\tfrm.refresh_fields(); \n\t\t\n\t}\n\tif (frm.doc.docstatus < 1) {\n\t    frm.set_df_property(\"attach_file\",\"hidden\", frm.is_dirty() ? true : false);\n\t    frm.dashboard.wrapper.parent().removeClass(\"hide\")\n            .parent().find(\".section-head\").removeClass(\"collapsed\")\n            .find(\".octicon.collapse-indicator.octicon-chevron-up\")\n            .removeClass()\n            .addClass(\"octicon collapse-indicator octicon-chevron-down\") \n            \n        if (!frm.doc.attach_file)\n            frm.dashboard.add_comment(__('Before able to upload payment from marketplace, you have to save document first'), 'orange', true);\n            \n        if (!frm.doc.attach_file){ \n            frm.set_value(\"import_status\",\"\"); frm.set_value(\"error_message\",\"\");\n        }\n\t}\n    \n    frappe.realtime.on(\"payment_entry_progress\", function(data) {\n\t\t\tif (data.data_import === frm.doc.name) {\n\t\t\t\tif (data.reload && data.reload === true) {\n\t\t\t\t    //console.log('reload here...')\n\t\t\t\t\tfrm.reload_doc();\n\t\t\t\t}\n\t\t\t\tconsole.log(data.progress);\n\t\t\t\tif (data.progress) {\n\t\t\t\t\tlet progress_bar = $(frm.dashboard.progress_area).find(\".progress-bar\");\n\t\t\t\t\t//console.log(data.progress_bar);\n\t\t\t\t\tif (progress_bar) {\n\t\t\t\t\t\t$(progress_bar).removeClass(\"progress-bar-danger\").addClass(\"progress-bar-success progress-bar-striped\");\n\t\t\t\t\t\t$(progress_bar).css(\"width\", data.progress + \"%\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n});\nfunction first(frm,total_outstanding,callback){\n        console.log(\"First\");\n\tfrm.doc.paid_amount = total_outstanding;\n\tfrm.script_manager.trigger(\"paid_amount\");\n\t//frm.script_manager.trigger(\"write_off_based_on_discount\");\n\tcallback();\n}\nfunction second(frm,total_outstanding){\n\treturn new Promise(function(resolve, reject){\n        console.log(\"Second\");\n\t//frm.doc.write_off_based_on_discount = 1;\n\tfrm.script_manager.trigger(\"write_off_based_on_discount\");\n        resolve();\n    \t});\n}\nfunction set_deductions(frm){\n\tif (frm.doc.discount_amount > 0 && frm.doc.write_off_based_on_discount){\n\t\tconsole.log('set deductions >>>>');\n\t\tfrm.doc.deductions = [];\n\t\trow = frm.add_child(\"deductions\");\n\t\tif (frm.doc.party.indexOf(\"Lazada\") < 0) row.account = \"Payment Cashback - HL\";\n\t\t\telse row.account = \"Fee Lazada - HL\";\n\t\t\trow.cost_center = \"Main - HL\";\n\t\t\tif (frm.doc.difference_amount)row.amount = frm.doc.difference_amount;\n\t\t\telse row.amount = frm.doc.discount_amount;\n\t\t}\n\t\telse if (frm.doc.discount_amount > 0 && !frm.doc.write_off_based_on_discount) \n\t\t\tfrm.doc.deductions = [];\n//callback();\n}\nfrappe.ui.form.on(\"Payment Entry\", \"paid_amount\", function(frm, cdt, cdn) {\n\tif (frm.doc.discount_amount){\n\t\tconsole.log('trigger paid amount first...');\n\t\tif (frm.doc.party.toUpperCase().indexOf(\"LAZADA\") > -1 && frm.doc.discount_amount){\n\t\t\tfrm.doc.write_off_based_on_discount = 1;\t\n\t\t\tfrm.script_manager.trigger(\"write_off_based_on_discount\");\n\t\t}\n\t}\t\n});\nfrappe.ui.form.on(\"Payment Entry\", \"write_off_based_on_discount\", function(frm, cdt, cdn) {\n\tconsole.log('write_off_based_on_discount');\n\tvar total_outstanding = 0;\n\tfrm.doc.deductions = [];\n\tif(frm.doc.discount_amount > 0 && frm.doc.write_off_based_on_discount) {\n\t\t$.each(frm.doc.references || [], function(i, r){\n\t\t\tfrappe.model.set_value(r.doctype,r.name,\"allocated_amount\", r.outstanding_amount);\n\t\t\ttotal_outstanding+=r.outstanding_amount;\n\t\t\tconsole.log('Row '+ i + '. Allocated_amount====' + r.allocated_amount);\n\t\t});\n\t\tset_deductions(frm);\n\t}\n\telse {\n\t\tfrm.set_value(\"paid_amount\",frm.doc.paid_amount + frm.doc.discount_amount);\n\t\tfrm.set_value(\"discount_amount\",0);\n\t}\n});\nfrappe.ui.form.on(\"Payment Entry\", \"discount_amount\", function(frm, cdt, cdn) {\n\tif(frm.doc.discount_amount > 0) {\n\t\tvar total_outstanding = 0;\n\t\t$.each(frm.doc.references || [], function(i, r){\n\t\t\ttotal_outstanding += r.outstanding_amount;\t\n\t\t\t//frappe.model.set_value(r.doctype,r.name,\"allocated_amount\", r.outstanding_amount);\n\t\t\t//console.log('allocated_amount====' + r.allocated_amount);\n\t\t});\n\n\t\t//net_paid = (100-frm.doc.discount_rate)/100 * total_outstanding;\n\t\tnet_paid = total_outstanding - frm.doc.discount_amount;\n\t\t//console.log('net_paid after discount ====' + net_paid);\n\n\t\tfrm.set_value(\"paid_amount\", net_paid); \n\t\t//frm.set_value(\"received_amount\", net_paid);\n\t\t//frm.set_value(\"difference_amount\", 0);\n\t\tfrm.doc.deductions = [];\n\t\t\n\t}\n\t//console.log('difference_amount====' + frm.doc.difference_amount);\n\t//console.log('received_amount====' + frm.doc.received_amount);\n});\nfrappe.ui.form.on(\"Payment Entry\", \"before_submit\", function(frm, cdt, cdn) {\n\tif (frm.doc.unallocated_amount && frm.doc.references){\n\t    frappe.throw(\"Unallocated amount found, please set deductions\");\n\t    frappe.validated = false; return;\n\t}\n});\n\nfrappe.ui.form.on(\"Payment Entry\", \"validate\", function(frm, cdt, cdn) {\n\tif (frappe.session.user.indexOf('sby') > -1)frm.doc.naming_series=\"SBY-PE/.YY./.MM./.###\";\n\telse frm.set_value(\"naming_series\", \"PE/.YY./.MM./.###\");\n\n\tvar total_outstanding = 0;\n\t$.each(frm.doc.references || [], function(i, r){\n\t    console.log(`${r.idx}`);\n\t\ttotal_outstanding += r.outstanding_amount;\t\n\t\tif (r.ordered_amount != 0 && r.ordered_amount != r.allocated_amount && r.reference_doctype == \"Sales Invoice\" && frm.doc.payment_type == \"Receive\"){\n\t\t    frappe.msgprint({title:__(\"Warning, but you can ignore this\"), indicator:'orange',\n\t\t\t\tmessage: __(\"Row \" + r.idx + \". Difference amount found : \" + Number(r.ordered_amount - r.allocated_amount).toLocaleString())});\n\t\t\t//frappe.msgprint(__(\"Row \" + r.idx + \". Difference amount found : \" + Number(r.ordered_amount - r.allocated_amount).toLocaleString()));\n\t\t\t$('div[data-fieldname=\"references\"]').find('div.grid-row[data-idx='+r.idx+']').css({'background-color':'#FDEDEC'})\n\t\t\t//frappe.validated = false; return;\n\t\t}\n\t});\n\tconsole.log('total_outstanding == ' + total_outstanding);\n\tconsole.log('frm.doc.party.toUpperCase().indexOf(\"LAZADA\") == ' + frm.doc.party.toUpperCase().indexOf(\"LAZADA\"));\n\tif (frm.doc.party.toUpperCase().indexOf(\"LAZADA\") > -1){\n\t\t//frm.set_value(\"discount_amount\",0.164 * total_outstanding);\n\t\tfrm.doc.discount_amount = 0.164 * total_outstanding;\n\t\ttotal_outstanding = total_outstanding - frm.doc.discount_amount;\n\t\t//frm.doc.write_off_based_on_discount = 1;\n\t\t//frm.script_manager.trigger(\"paid_amount\");\n\t}\n\tif (frm.doc.online_order_ids){\t\t\n\t\tfirst(frm,total_outstanding,function(c){\n\t\t\t//set_deductions(frm)\n\t\t\t//frm.script_manager.trigger(\"write_off_based_on_discount\");\n\t\t\t//frm.script_manager.trigger(\"paid_amount\");\n\t\t\t\n\t\t});\n\t\t\t\t\n\t}\n\t \n});\nfrappe.ui.form.on(\"Payment Entry\", \"online_order_ids\", function(frm, cdt, cdn) {\n\tfrm.doc.references = [];\n});\nfunction escapeRegExp(str) {\n    return str.replace(/([.*+?^=!:${}()|\\[\\]\\/\\\\])/g, \"\\\\$1\");\n}\nfunction replaceAll(str, find, replace) {\n    return str.replace(new RegExp(escapeRegExp(find), 'g'), replace);\n}\nfunction nth_occurrence (string, char, nth) {\n    var first_index = string.indexOf(char);\n    var length_up_to_first_index = first_index + 1;\n\n    if (nth == 1) {\n        return first_index;\n    } else {\n        var string_after_first_occurrence = string.slice(length_up_to_first_index);\n        var next_occurrence = nth_occurrence(string_after_first_occurrence, char, nth - 1);\n\n        if (next_occurrence === -1) {\n            return -1;\n        } else {\n            return length_up_to_first_index + next_occurrence;  \n        }\n    }\n}\n\nfrappe.ui.form.on(\"Payment Entry\", \"get_invoices\", function(frm, cdt, cdn) {\n    var total_outstanding = 0;\n    console.log('executing get invoices..');\n    //frm.events.add_progress_bar(frm);\n     frappe.call({\n\t\t\t\tmethod: \"custom1.custom1.marketplace_payment_updater.upload_marketplace_payment\",\n\t\t    \targs: {\n\t\t\t    \tdocname: frm.doc.name\n\t\t\t    },\n\t\t\t    freeze: true,\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\tif(!r.exc) {\n\t\t\t\t\t   //frm.events.onload(frm);\n\t\t\t\t\t   return;\n\t\t\t\t\t\t\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t    })\t\t\n   /* if(frm.doc.docstatus < 1 && frm.doc.party_type == \"Customer\" && frm.doc.party){\n\tif (!frm.doc.online_order_ids){\n\t\tfrm.set_value(\"online_order_ids\", frm.doc.online_order_ids.trim() + \"\\n\");\n\t\tfrm.doc.references = [];\n\t}\n\tvar order_ids = frm.doc.online_order_ids.trim().split(\"\\n\");\t\n\tvar arr_id = []; var arr_amount = [];\n\tvar obj_id = {};\n\tvar str; var _amount;\n\tvar ordered_amount = 0;\t\n\tvar row;\n\t//console.log('online_order_ids='+order_ids);\t\n\n\t$.each(order_ids || [], function(i, r){\n\t\tvar order_id = \"\";\n\n\t\t//get mutation amount and convert to float\n\t\tvar curr_idx = nth_occurrence(r, 'Rp', 1); //tokopedia\n\t\tconsole.log('curr_idx === ' + curr_idx);\n\t\t//console.log('get amount string === ' + r.substring(0,r.length).replace(\".\",\"\"));\n\t\tif (curr_idx >= 0 || !isNaN(parseFloat(r.substring(0,r.length).replace(\".\",\"\")))){\n\t\t\tvar str = r.substring(curr_idx,r.length); //tokped\n\t\t\t//bukalapak\n\t\t\tif (r.indexOf('#') > 0){ //bukalapak)\n\t\t\t\torder_id = r.substring(r.indexOf('#')+1,r.trim().length); //bukalapak\n\t\t\t\tif (arr_id.length == 0)arr_id.push(order_id);\n\t\t\t}\n\t\t\tif (nth_occurrence(r, 'Rp', 2) >= 0)str = r.substring(curr_idx,nth_occurrence(r, 'Rp', 2)-1);\n\t\t\tstr = replaceAll(str,\".\",\"\");\n\t\t\tstr = str.replace(\",\",\".\");\n\t\t\tstr = str.replace(\"Rp\",\"\");\t\t\n\t\t\t//var _amount = parseFloat(str.replace(/[^0-9\\.-]+/g,\"\"));\n\t\t\tif (nth_occurrence(r, 'Rp', 2) >= 0 || nth_occurrence(r, 'Rp', 1) >= 0)\n\t\t\t\t_amount = parseFloat(str.trim()); \n\t\t\tif (r.includes('Sisa') || r.includes('Saldo') || curr_idx < 0)_amount=0;\n\t\t\t//console.log('str === ' + str);\n\t\t\tconsole.log('_amount 1 === ' + _amount);\n\t\t\tif (!isNaN(_amount) && (arr_id.length >= 2))arr_id=[];\n\t\t\tif (arr_id.length == 1 && !isNaN(_amount) && curr_idx >=0){// && !isNaN(str.trim())){ \n\t\t\t\tarr_id.push(_amount); obj_id[arr_id[0]] = _amount;\n\t\t\t\tarr_amount.push(obj_id); \t\t\t\n\t\t\t\tconsole.log('arr_amount by order_id 222 == ' + arr_amount[0][order_id]);\t \n\t\t\t}\n\t\t\tconsole.log('arr_id == ' + arr_id);\n\t\t\t//console.log('arr_amount 55 == ' + arr_amount[0]['INV/20171204/XVII/XII/120055955']);\n\t\t\t//console.log('arr_amount 56 == ' + arr_amount[0]['INV/20171204/XVII/XII/120055956']);\n\t\t}\t\t\n\n\t\torder_id = r.substring(r.indexOf('INV/'),r.trim().length); //tokopedia\n\t\tif (r.indexOf('INV/') < 0) order_id = r.substring(r.indexOf('#')+1,r.trim().length); //bukalapak\n\t\tconsole.log('order_id == '+ order_id);\n\t\t//console.log('indexOf INV == '+ r.indexOf('INV/'));\n\t\t//console.log('indexOf # == '+ r.indexOf('#'));\n\t\tif (r.indexOf('INV/') < 0 && r.indexOf('#') < 0){\n\t\t\t//var shopee_id = parseFloat(r.trim().substring(0,15));\n\t\t\tvar shopee_id = r.trim()//.substring(0,14);\n\t\t\tconsole.log('shopee here == ' + shopee_id);\n\t\t\t//console.log('shopee_id.length == ' + shopee_id.toString().length);\n\t\t\tif (!isNaN(shopee_id.substring(0,6)) && shopee_id.toString().length >=14){\n\t\t\t\torder_id = r.substring(0,14)\n\t\t\t\tconsole.log('shopee_id == ' + order_id);\n\t\t\t\tif (order_id.length < 14)return;\n\t\t\t}\n\t\t\telse { return; }// goto next loop\n\t\t}\n\t\tif (arr_id.length == 0 && order_id.length >=12)arr_id.push(order_id);\n\t\tconsole.log('arr_id.length == ' + arr_id.length);\n\t\tconsole.log('update arr_amount == ' + _amount);\n\t\tif (arr_id.length == 1 && !isNaN(_amount) && _amount != 0){// && !isNaN(str.trim())){ \n\t\t\t//obj_id={};\n\t\t\tarr_id.push(_amount); obj_id[arr_id[0]] = _amount;\n\t\t\tarr_amount.push(obj_id); \n\t\t\tconsole.log('obj_id == ' + JSON.stringify(obj_id));\t\t\t\t \n\t\t\tconsole.log('arr_amount by order_id == ' + JSON.stringify(arr_amount));\n\t\t}\n\t\tif (arr_id.length >= 2)arr_id=[];\n\n\t\t//if (frm.doc.references.length >=1){\n\t\t    console.log('frm.doc.references.length == ' + frm.doc.references.length);\n\t\t\trow = frm.doc.references.find(function(obj){ \n\t\t\t\treturn obj.reference_name.indexOf(order_id) > -1; \n\t\t\t});\n\t\t//}\n\t\tconsole.log('existing reference_name == '+ row);\n\t\tif (arr_id.length ==2)ordered_amount = arr_id[1];\t\n\t\tif ((!row || row == undefined)){\t\t\n\t\t\t//console.log('arr_id 22 == ' + arr_id);\n\t\t\tfrappe.call({\n\t\t\t\tmethod: \"custom1.custom1.custom1.an_get_invoice_by_orderid\", \n\t\t\t\targs: {\n\t\t\t\t\t\"order_id\" : order_id,\n\t\t\t\t\t\"customer\" : frm.doc.party\n\t\t\t\t},\n\t\t\t\tcallback: function(r) {\n\t\t\t\t\t//console.log('arr_id 33 == ' + arr_id);\n\t\t\t\t\tif(!r.exc && r.message){\n\t\t\t\t\t\trow = frm.doc.references.find(function(obj){ \n\t\t\t\t\t\t\treturn obj.reference_name.indexOf(r.message[0][0]) > -1; \n\t\t\t\t\t\t});\n\t\t\t\t\t\tif (row) return;\n\t\t\t\t\t\tconsole.log('success get invoice == ' + r.message[0][0]);\n\t\t\t\t\t\tconsole.log('add new row..');\n\t\t\t\t\t\trow = frm.add_child(\"references\");\n\t\t\t\t\t\trow.reference_doctype = \"Sales Invoice\";\n\t\t\t\t\t\tfrappe.model.set_value(row.doctype, row.name, \"reference_name\",r.message[0][0]); //row.allocated_amount = r.message[0][1];\n\t\t\t\t\t    frappe.model.set_value(row.doctype, row.name, \"allocated_amount\",r.message[0][1]);\n\t\t\t\t\t\tconsole.log('obj_id[order_id] == ' + obj_id[order_id]);\n\t\t\t\t\t\tvar obj_amount;\n\t\t\t\t\t\tobj_amount = arr_amount.find(function(obj){ \n\t\t\t\t\t\t\tif (r.message[0][0].indexOf(order_id) > -1){\n\t\t\t\t\t\t\t\treturn obj; \n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\t\t\t\t\t\n\t\t\t\t\t\tif (obj_amount)console.log('obj_amount == ' + obj_amount[order_id]);\n\t\t\t\t\t\tif (obj_amount) row.ordered_amount = obj_amount[order_id];\n\t\t\t\t\t\telse if (obj_id[order_id])\n\t\t\t\t\t\t\trow.ordered_amount = obj_id[order_id];\n\t\t\t\t\t\t\n\t\t\t\t\t\ttotal_outstanding += r.message[0][1];\n\t\t\t\t\t\t//arr_id = [];\n\t\t\t\t\t\t//console.log('arr_id after inserting new row == ' + arr_id);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\trefresh_field(\"references\");\n\t\t//console.log('frm.doc.references == ' + frm.doc.references);\n\t\t//console.log('total_outstanding == ' + total_outstanding);\n\t\t//frm.set_value(\"paid_amount\", total_outstanding);\n\t});\n    } */\n});\n"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "User",
  "modified": "2018-08-31 15:39:26.716951",
  "name": "User-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"User\", \"validate\", function(frm, cdt, cdn) {\n\tif (!frappe.user.has_role(\"System Manager\") && frm.doc.email == \"jof2jc@gmail.com\"){\n\t\tfrappe.validated = false;\n\t\tfrappe.throw(\"Not Allowed to change this user\");\n\t\treturn;\n\t}\n\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Stock Settings",
  "modified": "2019-08-24 11:25:38.600093",
  "name": "Stock Settings-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Stock Settings\", \"onload\", function(frm, cdt, cdn) { \n\tconsole.log(frappe.get_doc('Item', 'PRN17AB'));\n\tconsole.log(frappe.get_list('Sales Invoice','181095347142-01'));\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Journal Entry",
  "modified": "2020-05-22 20:34:08.020960",
  "name": "Journal Entry-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Journal Entry\", \"validate\", function(frm, cdt, cdn) {\r\n\tfrm.script_manager.trigger(\"voucher_type\");\r\n\tif (frm.doc.voucher_type == \"Cash Bank Entry\"){\r\n\t\tfrm.doc.accounts = [];\t\r\n\t\ttotal_debit = 0;\r\n\t\tfrm.doc.user_remark =\"\";\r\n\t\t$.each(frm.doc.expenses, function(i, r){ \r\n\t\t\tif (!r.account_description)r.account_description=\"\";\r\n\t\t\trow = frm.add_child(\"accounts\");\r\n\t\t\trow.account = r.account_code;\r\n\t\t\trow.account_description = r.account_description;\r\n\t\t\tif (r.account_description)frm.doc.user_remark += r.account_description + \"#\";\r\n\t\t\tif (frm.doc.cash_type == \"In\")row.credit_in_account_currency = r.amount;\r\n\t\t\telse row.debit_in_account_currency = r.amount;\r\n\t\t\ttotal_debit += r.amount;\r\n\t\t\trow.cost_center = r.cost_center;\r\n\t\t});\r\n\t\tconsole.log('total_debit == ' + total_debit);\r\n\t\trow = frm.add_child(\"accounts\");\r\n\t\trow.account = frm.doc.cash_bank_account;\r\n\t\tif (frm.doc.cash_type == \"In\")row.debit_in_account_currency = total_debit;\r\n\t\telse row.credit_in_account_currency = total_debit;\r\n\t}\r\n});\r\nfrappe.ui.form.on(\"Journal Entry\", \"onload_post_render\", function(frm, cdt, cdn) {\r\n\tfrm.fields_dict['cash_bank_account'].get_query = function(frm, cdt, cdn) {\r\n\t\tconsole.log('trigger query cash_bank_account');\r\n\t\td = locals[cdt][cdn];\r\n\t\t\treturn {\r\n\t\t\t\tfilters:[\r\n\t\t\t\t\t\t['account_type', 'in', ['Cash','Bank']],\r\n\t\t\t\t\t\t['is_group', '=', '0'],\r\n\t\t\t\t\t\t['freeze_account', '=', 'No']\r\n\t\t\t\t\t]\r\n\t\t\t}\r\n\t}\r\n\tfrm.fields_dict.expenses.grid.wrapper.on('focus', 'input[data-fieldname=\"account_code\"][data-doctype=\"Journal Entry Expenses\"]', function(e){\r\n\t\tvar current_doc = $('.data-row.editable-row').parent().attr(\"data-name\");\r\n        \tvar d = locals[\"Journal Entry Expenses\"][current_doc];\r\n\t\t//refresh_field(\"references\");\r\n\t\tfrm.fields_dict['expenses'].grid.get_field('account_code').get_query = function(frm, cdt, cdn) {\t\r\n\t\t\tvar d = locals[cdt][cdn];\r\n\t\t\tconsole.log('trigger set query for account 1');\r\n\t\t\t//if (d.reference_doctype == \"Sales Invoice\"){\t\t\r\n\t\t\t\treturn {\r\n\t\t\t\t\tfilters:[\r\n\t\t\t\t\t\t//['root_type', 'in', ['Expense','Asset','Income']],\r\n\t\t\t\t\t\t['is_group', '=', '0'],\r\n\t\t\t\t\t\t['freeze_account', '=', 'No']\r\n\t\t\t\t\t]\r\n\t\t\t\t}\r\n\t\t\t//}\r\n\t\t}\r\n\t})\r\n\tfrm.fields_dict['expenses'].grid.get_field('account_code').get_query = function(frm, cdt, cdn) {\t\r\n\t\tvar d = locals[cdt][cdn];\r\n\t\tconsole.log('trigger set query for account 2');\r\n\t\t//if (d.reference_doctype == \"Sales Invoice\"){\t\t\r\n\t\t\treturn {\r\n\t\t\t\tfilters:[\r\n\t\t\t\t\t//['root_type', 'in', ['Expense','Asset','Income']],\r\n\t\t\t\t\t['is_group', '=', '0'],\r\n\t\t\t\t\t['freeze_account', '=', 'No']\r\n\t\t\t\t]\r\n\t\t\t}\r\n\t\t//}\r\n\t}\r\n});\r\nfrappe.ui.form.on(\"Journal Entry\", \"voucher_type\", function(frm, cdt, cdn) {\r\n\tif (frm.doc.voucher_type == \"Cash Bank Entry\"){\r\n\t\tfrm.set_df_property(\"sc_expenses\",\"hidden\",false);frm.set_df_property(\"expenses\",\"hidden\",false);\r\n\t\tfrm.set_df_property(\"accounts\",\"hidden\",1);\r\n\t\t//frm.doc.accounts = [];\r\n\t}\r\n\telse {\r\n\t\tfrm.doc.expenses = [];\r\n\t\tfrm.doc.cash_bank_account = \"\";\r\n\t\tfrm.set_df_property(\"sc_expenses\",\"hidden\",true);frm.set_df_property(\"expenses\",\"hidden\",true);\r\n\t\tfrm.set_df_property(\"accounts\",\"hidden\",0);\r\n\t}\r\n});\r\nfrappe.ui.form.on(\"Journal Entry\", \"refresh\", function(frm, cdt, cdn) {\r\n\t//if (frm.doc.user_remark)frm.doc.user_remark = \"\";\r\n\tfrm.script_manager.trigger(\"voucher_type\");\r\n\t$.each(frm.doc.accounts, function(i, r){ \t\r\n\t\t//if (r.account_description)frm.doc.user_remark = frm.doc.user_remark.replace(undefined,\"\") + \"#\" + r.account_description +\"#\";\r\n\t\t//if (frappe.session.user.indexOf('kasirkrekot') > -1) r.cost_center = \"Retail Krekot - DUN\";\r\n\t\tif (frappe.session.user.indexOf('bengkel') > -1) r.cost_center = \"Workshop Millenium - DUN\";\r\n\t});\r\n});\r\nfrappe.ui.form.on(\"Journal Entry Account\", \"account\", function(frm, cdt, cdn) {\r\n\t//if (frm.doc.user_remark)frm.doc.user_remark = \"\";\r\n\td = locals[cdt][cdn];\r\n\t//if (frappe.session.user.indexOf('kasir') > -1)\r\n\tfrappe.model.set_value(cdt,cdn,\"cost_center\",\"\");\r\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Pick List",
  "modified": "2020-06-17 19:06:26.996037",
  "name": "Pick List-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on('Pick List', {\n    onload(frm) {\n      frm.set_value(\"purpose\",\"Delivery\");  \n    },\n\trefresh(frm) {\n\t    frm.toggle_enable(['purpose','parent_warehouse','get_item_locations'], 0);\n\t    frm.toggle_display(['purpose','parent_warehouse','get_item_locations'], 0);\n\t\tfrm.trigger('add_get_items_button');\n\t},\n\tadd_get_items_button: (frm) => {\n\t\tlet purpose = frm.doc.purpose;\n\t\tif (purpose != 'Delivery' || frm.doc.docstatus !== 0) return;\n\t\t/* let get_query_filters = {\n\t\t\tdocstatus: 0,\n\t\t\tis_return: ['=', 0],\n\t\t\tstatus: ['!=', ''],\n\t\t\torder_status: ['in',['To Pick','Pending']],\n\t\t\titems: ['is_picked','=',0],\n\t\t\tcustomer: frm.doc.customer\n\t\t};*/\n\t\tlet get_query_filters = [\n\t\t       ['customer','=',frm.doc.customer],\n\t\t       ['docstatus','=',0],\n\t\t       ['is_return','=',0],\n\t\t       ['Sales Invoice Item','is_picked','=',0],\n\t\t       ['order_status','in',['To Pick','Pending']],\n\t\t];\n\t\tfrm.get_items_btn = frm.add_custom_button(__('Get Items From Marketplace Orders'), () => {\n\t\t\tif (!frm.doc.customer) {\n\t\t\t\tfrappe.msgprint(__('Please select Customer first'));\n\t\t\t\treturn;\n\t\t\t}else if (frm.is_dirty()){\n\t\t\t    frappe.msgprint(__('Please save document first'));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\terpnext.utils.map_current_doc({\n\t\t\t\tmethod: 'custom1.marketplace_flow.marketplace_flow.get_pick_list_items',\n\t\t\t\tsource_doctype: 'Sales Invoice',\n\t\t\t\ttarget: frm,\n\t\t\t\tsetters: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: \"Customer\",\n\t\t\t\t\t\t\tfieldname: \"customer\",\n\t\t\t\t\t\t\tfieldtype: \"Link\",\n\t\t\t\t\t\t\toptions: frm.doc.customer || ''\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlabel: \"AWB No\",\n\t\t\t\t\t\t\tfieldname: \"awb_no\",\n\t\t\t\t\t\t\tfieldtype: \"Data\"\n\t\t\t\t\t\t}\n\t\t\t\t\t],\n\t\t\t\tdate_field: 'posting_date',\n\t\t\t\tget_query_filters: get_query_filters\n\t\t\t\t    \n\t\t\t});\n\t\t});\n\t}\n})"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Pick Item",
  "modified": "2020-08-01 17:41:38.452262",
  "name": "Pick Item-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Pick Item\", \"onload\", function(frm, cdt, cdn) { \r\n\tfrm.trigger(\"load_to_pick_table\");\r\n\tfrm.disable_save();\r\n\t//frm.set_df_property(\"total_item_qty\", \"read_only\", 1);\r\n});\r\nfrappe.ui.form.on(\"Pick Item\", \"store_name\", function(frm, cdt, cdn) { \r\n\tfrm.trigger(\"load_to_pick_table\");\r\n});\r\nfrappe.ui.form.on(\"Pick Item\", \"row_limit\", function(frm, cdt, cdn) { \r\n\tfrm.trigger(\"load_to_pick_table\");\r\n});\r\nfrappe.ui.form.on(\"Pick Item\", \"load_unpicked_items\", function(frm, cdt, cdn) { \r\n    frm.trigger(\"load_to_pick_table\");\r\n    return;\r\n    \r\n\tfrm.doc.items = [];\r\n\treturn frm.call({\r\n\t\t\tdoc: frm.doc,\r\n\t\t\tmethod: \"load_to_pick_table\", //\"load_unpicked_items\",\r\n\t\t\tcallback: function(r) {\r\n\t\t\t\tif(!r.exc) refresh_field(\"to_pick_table\");\r\n\t\t\t}\r\n\t\t});\r\n});\r\nfrappe.ui.form.on(\"Pick Item\", \"clear_fields\", function(frm, clear_order_table=1) {\r\n    frm.set_value(\"order_qty\", 0);frm.set_value(\"picked_qty\", 0);frm.set_value(\"status\", \"\");frm.set_value(\"item_code\", \"\");\r\n    frm.set_value(\"total_item_qty\", 0);\r\n    frm.set_value(\"image\", \"\");\r\n    if (clear_order_table) $(frm.fields_dict.order_html_table.wrapper).empty();\r\n});\r\n\r\nfrappe.ui.form.on(\"Pick Item\", \"btn_scan_new\", function(frm, cdt, cdn) {\r\n    console.log('trigger scan new...');\r\n    frm.events.clear_fields(frm);\r\n\tfrm.set_value(\"scan_serial_batch\", \"\");\r\n\t$('[data-fieldname = scan_awb_order]').select();\r\n});\r\n\r\nfrappe.ui.form.on(\"Pick Item\", \"generate_to_pick_table\", function(frm, cdt, cdn) { \r\n\tif (frm.doc.to_pick_log) {\r\n\t    let msg = JSON.parse(frm.doc.to_pick_log);\r\n\t    var $log_wrapper = $(frm.fields_dict.to_pick_table.wrapper).empty();\r\n\t    console.log(\"render order table == \" + msg.messages);\r\n\t    $(frappe.render_template(\"to_pick_table\", {\r\n\t\t    data: msg.messages\r\n\t    })).appendTo($log_wrapper);\r\n\t}\r\n});\r\nfunction myfocus (frm){\r\n    $('[data-fieldname = row_limit').select().focus();\r\n}\r\nfrappe.ui.form.on(\"Pick Item\", \"load_to_pick_table\", function(frm, cdt, cdn) { \r\n    frm.events.clear_fields(frm);\r\n    if (frm.doc.row_limit > 200){\r\n        frappe.msgprint({'message': \"Cannot set more than 200 Order Nos at once\", 'custom_onhide':myfocus()});\r\n        return;\r\n    }\r\n    console.log('load_to_pick_table');\r\n    $(frm.fields_dict.to_pick_table.wrapper).empty();\r\n\treturn frm.call({\r\n\t\t\tdoc: frm.doc,\r\n\t\t\tmethod: \"load_to_pick_table\",\r\n\t\t\tcallback: function(r) {\r\n\t\t\t\tif(!r.exc) {\r\n\t\t\t\t    if (frm.doc.to_pick_log) {\r\n\t\t\t            frm.events.generate_to_pick_table(frm);\r\n\t\t            } else if (frm.doc.to_pick_log !== undefined) {\r\n\t\t\t            $(frm.fields_dict.to_pick_table.wrapper).empty();\r\n\t\t            }\r\n\t\t\t\t    refresh_field(\"to_pick_table\");\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function(r) {\r\n\t\t\t\tconsole.log('error load_to_pick_table === ' + r);\r\n\t\t\t}\r\n\t\t});\r\n});\r\n\r\nfrappe.ui.form.on(\"Pick Item\", \"generate_order_table\", function(frm, cdt, cdn) { \r\n\tif (frm.doc.order_log) {\r\n\t    let msg = JSON.parse(frm.doc.order_log);\r\n\t    var $log_wrapper = $(frm.fields_dict.order_html_table.wrapper).empty();\r\n\t    console.log(\"render order table == \" + msg.messages);\r\n\t    $(frappe.render_template(\"order_html_table\", {\r\n\t\t    data: msg.messages\r\n\t    })).appendTo($log_wrapper);\r\n\t}\r\n});\r\n\r\nfrappe.ui.form.on(\"Pick Item\", \"load_order_detail\", function(frm, cdt, cdn) { \r\n    if (!frm.doc.scan_awb_order)return;\r\n\treturn frm.call({\r\n\t\t\tdoc: frm.doc,\r\n\t\t\tmethod: \"load_order_detail\",\r\n\t\t\tcallback: function(r) {\r\n\t\t\t\tif(!r.exc) {\r\n\t\t\t\t    console.log(\"frm.doc.order_log == \" + frm.doc.order_log);\r\n\t\t\t\t    if (frm.doc.order_log) {\r\n\t\t\t            frm.events.generate_order_table(frm);\r\n\t\t            } else if (frm.doc.order_log !== undefined) {\r\n\t\t\t            $(frm.fields_dict.order_html_table.wrapper).empty();\r\n\t\t            }\r\n\t\t\t\t    refresh_field(\"order_html_table\");\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function(r) {\r\n\t\t\t\tconsole.log('error load_order_detail === ' + r);\r\n\t\t\t}\r\n\t\t});\r\n});\r\n\r\nfrappe.ui.form.on(\"Pick Item\", \"scan_awb_order\", function(frm, cdt, cdn) { \r\n\tif (!frm.doc.scan_awb_order)return;\r\n\tfrm.events.clear_fields(frm);\r\n\t//frm.set_value(\"scan_serial_batch\", \"\");\r\n\t\r\n\tvar inv = \"\";\r\n\tfrappe.db.get_value(\"Sales Invoice\", {\"no_online_order\":frm.doc.scan_awb_order.trim(),\"is_return\":0, \"docstatus\":[\"<=\",2]}, [\"name\",\"awb_no\",\"docstatus\"], function(value){ \r\n\tconsole.log('value === ' + value);\r\n\tfrappe.db.get_value(\"Sales Invoice\", {\"awb_no\":frm.doc.scan_awb_order.trim(),\"is_return\":0,\"docstatus\":[\"<=\",2]}, [\"name\",\"awb_no\",\"docstatus\"], function(v){ \t\r\n\t\tconsole.log('v === ' + v);\r\n\t\tif (value === undefined || !value){\t\r\n\t\t\tif (v === undefined || !v){\r\n\t\t\t\tfrm.set_value(\"status\",\"Order No / AWB not found!\");\r\n\t\t\t\t$('[data-fieldname = scan_awb_order]').select(); return;\r\n\t\t\t}else value = v;\r\n\t\t}\r\n\t\tconsole.log('value.name === ' + value.name);\r\n\t\tif (value.name && value.docstatus === 0) {\r\n\t\t    console.log('here..after scan awb');\r\n\t\t\tfrm.set_value(\"status\",\"\");\r\n\t\t\tfrm.set_value(\"scan_serial_batch\", \"\");\r\n\t\t\tfrm.events.load_order_detail(frm);\r\n\t\t\t$('[data-fieldname = scan_serial_batch]').select();\r\n\t\t} else if (value.docstatus == 1) {\r\n\t\t\tfrm.set_value(\"status\",\"Order No / AWB No was already delivered\");\r\n\t\t\t$('[data-fieldname = scan_awb_order]').select();\r\n\t\t} else if (value.docstatus == 2) {\r\n\t\t\tfrm.set_value(\"status\",\"Order No / AWB No is cancelled\");\r\n\t\t\t$('[data-fieldname = scan_awb_order]').select();\r\n\t\t} \r\n\t\tfrm.refresh_field(\"status\");\t\r\n\t});\t\r\n});\r\n});\r\n\r\nfrappe.ui.form.on(\"Pick Item\", \"scan_serial_batch\", function(frm, cdt, cdn) { \r\n\t//frm.set_value(\"awb_status\",\"\");\r\n\tif (!frm.doc.scan_serial_batch)return;\r\n\t//frm.events.clear_fields(frm,0);\r\n\t\r\n\tconsole.log('frm.doc.scan_serial_batch === ' + frm.doc.scan_serial_batch);\r\n\t\r\n\tvar inv = \"\";\r\n\r\n\tfrappe.db.get_value(\"Serial No\", {\"serial_no\":frm.doc.scan_serial_batch, \"status\":[\"not in\",[\"Delivered\",\"Expired\"]]}, [\"name\",\"item_code\"], function(v1){ \r\n\t\tconsole.log('serial v1 === ' + v1);\r\n\tfrappe.db.get_value(\"Batch\", {\"name\":frm.doc.scan_serial_batch, \"disabled\":0}, [\"name\",\"item\"], function(v2){ \t\r\n\t\tconsole.log('Batch v2 === ' + v2);\r\n\tfrappe.db.get_value(\"Item\", {\"name\":frm.doc.scan_serial_batch, \"is_stock_item\":1, \"disabled\":0}, [\"name\",\"item_code\"], function(v3){ \t\r\n\t\tconsole.log('Item v3 === ' + v3);\r\n\r\n        var item_code = \"\";\r\n\t\tif (v1 == undefined || !v1){\t\r\n\t\t\tif ((v2 == undefined || !v2) && (v3 == undefined || !v3)){\r\n\t\t\t\t//frm.set_value(\"status\",\"Serial No / Batch / SKU Not Found\");frm.refresh_field(\"status\");\r\n\t\t\t\t//$('[data-fieldname = scan_serial_batch]').select();return;\r\n\t\t\t} //else { v1 = v2; item_code = v2.item; }\r\n\t\t}\r\n\t\tif (v2) item_code=v2.item;\r\n\t\telse if (v3)item_code=v3.item_code\r\n\t\telse if (v1)item_code = v1.item_code\r\n\t\telse item_code = frm.doc.scan_serial_batch;\r\n\r\n        console.log('frm.doc.scan_serial_batch === ' + frm.doc.scan_serial_batch);\r\n        console.log('item_code === ' + item_code);\r\n        \r\n\t\tif (item_code){\r\n\t\t\t//item_code = v1.item_code;\r\n\t\t\t//frm.set_value(\"item_code\",item_code);\r\n\t\t\t//frm.events.set_total_item_qty(frm);\r\n            //frm.events.total_item_qty(frm, item_code);\r\n\t\t\tconsole.log(\"call set serial batch into ordered item == \" + item_code);\r\n\t\t\tfrappe.call({\r\n\t\t\t\tmethod: \"custom1.marketplace_flow.doctype.pick_item.pick_item.update_picked_item\", \r\n\t\t\t\targs: {\r\n\t\t\t\t\t\"awb_order_no\": frm.doc.scan_awb_order.trim(),\r\n\t\t\t\t\t\"serial_batch_no\": frm.doc.scan_serial_batch.trim(),\r\n\t\t\t\t\t\"item_code\": item_code,\r\n\t\t\t\t\t\"total_item_qty\": frm.doc.total_item_qty || 0\r\n\t\t\t\t},\r\n\t\t\t\tcallback: function(r) {\r\n\t\t\t\t\tconsole.log(\"result === \" + r.message);\r\n\t\t\t\t\tif (r.message){\r\n\t\t\t\t\t\tfrm.set_value(\"order_qty\", r.message[0]);\r\n\t\t\t\t\t\tfrm.set_value(\"picked_qty\", r.message[1]);\r\n\t\t\t\t\t\tfrm.set_value(\"status\", r.message[3]);frm.refresh_field(\"status\");\r\n\t\t\t\t\t\tif (r.message[4]) {\r\n\t\t\t\t\t\t    frm.set_value(\"item_code\", r.message[4]);\r\n\t\t\t\t\t\t    item_code = r.message[4];\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (r.message[5]) frm.set_value(\"image\", r.message[5]); frm.refresh_field(\"image_view\");\r\n\t\t\t\t\t\r\n\t\t\t\t\t    $.each(frm.doc.items, function(i, d){ \t\t\t\r\n\t\t\t\t\t\t    if (item_code == d.item_code && (frm.doc.scan_awb_order == d.order_no || frm.doc.scan_awb_order == d.awb_no)){\r\n\t\t\t\t    \t\t    console.log('found match item...');\r\n\t\t\t\t\t    \t    console.log(\"r.picked_qty === \" + r.message[1]);\r\n\t\t\t\t\t\t        console.log(\"r.order_qty === \" + r.message[0]);\r\n\t\t\t\t\t\t        if (r.message[1]) frappe.model.set_value(d.doctype, d.name, \"picked_qty\", r.message[1]);\r\n\t\t\t\t\t\t        if (r.message[1] == d.order_qty) frappe.model.set_value(d.doctype, d.name, \"is_picked\", 1);\r\n\t\t\t\t\t\t    }\r\n\t\t\t\t\t    }); frm.refresh_field('items');\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t\t//frm.events.load_order_detail(frm);\r\n\t\t\t\t\t//frm.set_value(\"scan_serial_batch\",\"\");\r\n\t\t\t\t\t//console.log('scan_serial_batch == ' + frm.doc.scan_serial_batch);\r\n\t\t\t\t\t\r\n\t\t\t\t    $('[data-fieldname = scan_serial_batch]').select();\r\n\t\t\t\t    frm.events.load_order_detail(frm);\r\n\t\t\t\t},\r\n\t\t\t\terror: function(r) {\r\n\t\t\t\t\tconsole.log('error === ' + r);\r\n\t\t\t\t\tfrm.set_value(\"scan_serial_batch\",\"\");\r\n\t\t\t\t\tfrm.set_value(\"status\",\"Error\");\r\n\t\t\t\t\t$('[data-fieldname = scan_serial_batch]').select();\r\n\t\t\t\t},\r\n\t\t\t\tfinally: function(r){\r\n\t\t\t\t    console.log('reload order_detail table');\r\n\t\t\t\t    frm.events.load_order_detail(frm);\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t}) \r\n\t\t}\t\r\n\t}); \r\n\t});\r\n\t});\r\n\t//frm.set_value(\"scan_awb_barcode\",\"\");\r\n\t//$('[data-fieldname = scan_awb_barcode]').select().focus();\t\r\n});\r\nfrappe.ui.form.on(\"Pick Item\", \"set_total_item_qty\", function(frm) {\r\n    console.log('set property full item qty');\r\n    if (frm.doc.picked_qty < frm.doc.order_qty)frm.set_df_property(\"total_item_qty\", \"read_only\", 0);\r\n    else frm.set_df_property(\"total_item_qty\", \"read_only\", 1);\r\n    frm.refresh_field(\"total_item_qty\");\r\n});\r\nfrappe.ui.form.on(\"Pick Item\", \"total_item_qty\", function(frm, item_code=\"\") {\r\n    //if (!item_code)item_code = frm.doc.scan_serial_batch;\r\n    frm.events.scan_serial_batch(frm);\r\n});\r\nfrappe.ui.form.on(\"Pick Item\", \"update_picked_qty\", function(frm, item_code=\"\") {\r\n        if (item_code){\r\n            \r\n        }\t\r\n});\r\n\r\nfrappe.ui.form.on(\"Pick Item\", \"btn_refresh_items\", function(frm, cdt, cdn) { \r\n\tif (frm.doc.cancelled){\r\n\t\tconsole.log('cancel here...')\r\n\t\tfrappe.call({\r\n\t\t\t\tmethod: \"custom1.custom1.scan_print.awb_invoice\", \r\n\t\t\t\targs: {\r\n\t\t\t\t\t\"ref\": frm.doc.name || \"\",\r\n\t\t\t\t\t\"awb_no\": \"JJJJJJJJJJJJkKKKKK\",\r\n\t\t\t\t\t\"courier\": frm.doc.marketplace_courier,\r\n\t\t\t\t\t\"company\": frm.doc.company,\r\n\t\t\t\t\t\"territory\": frm.doc.territory,\r\n\t\t\t\t\t\"cancelled\": frm.doc.cancelled\r\n\t\t\t\t},\r\n\t\t\t\tcallback: function(r) {\r\n\t\t\t\t\tconsole.log(\"cancel result === \" + r);\r\n\t\t\t\t\tfrm.set_value(\"awb_status\", r.message);\r\n\t\t\t\t\tfrm.set_value(\"scan_awb_barcode\",\"\");\r\n\t\t\t\t\t$('[data-fieldname = scan_awb_barcode]').select();return;\r\n\t\t\t\t}\r\n\t\t});\r\n\t}\r\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Marketplace Outbond Receipt",
  "modified": "2020-08-02 08:17:32.875380",
  "name": "Marketplace Outbond Receipt-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Marketplace Courier Reference\", \"marketplace_courier\", function(frm, cdt, cdn) { \r\n    var d = locals[cdt][cdn];\r\n    $.each(frm.doc.courier_references, function(i, r) {\r\n        if (d.marketplace_courier == r.marketplace_courier && r.name != d.name){\r\n\t\t    frappe.msgprint(\"This courier already selected. Please select another\");\r\n\t\t    d.marketplace_courier= \"\";\r\n\t\t}\r\n\t});\r\n\t\t\r\n    if (d.marketplace_courier){\r\n        frm.call('get_last_pickup_session', \r\n            {\r\n                courier: d.marketplace_courier\r\n            })\r\n            .then(r => {\r\n                if (r.message) {\r\n                    console.log(\"last_pickup_session == \" + r.message);\r\n                    var session = parseInt(r.message) + 1;\r\n                    frm.set_value(\"pickup_session\",session);\r\n                }\r\n            });\r\n    }\r\n});\r\nfrappe.ui.form.on(\"Marketplace Outbond Receipt\", \"onload\", function(frm, cdt, cdn) { \r\n    console.log(\"onload\");\r\n    frappe.db.get_value(\"Local Marketplace Settings\",\"\", \"ignore_courier_master_check\", function(value){ \r\n        console.log(\"ignore_courier_master_check = \" + value.ignore_courier_master_check);\r\n        if (value)frm.set_value(\"ignore_courier_master_check\",value.ignore_courier_master_check);\r\n    });\r\n});\r\nfrappe.ui.form.on(\"Marketplace Outbond Receipt\", \"onload_post_render\", function(frm, cdt, cdn) { \r\n\t//if (!frm.doc.marketplace_courier)$('[data-fieldname = marketplace_courier]').focus();\r\n\tif (!frm.doc.customer)$('[data-fieldname = customer]').focus();\r\n\telse $('[data-fieldname = scan_data]').select();\r\n\t\r\n\tfrm.set_df_property(\"date\",\"read_only\",1);\r\n});\r\n\r\nfrappe.ui.form.on(\"Marketplace Outbond Receipt\", \"validate\", function(frm, cdt, cdn) { \r\n\t//frm.disable_save();\r\n\t//clear_fields(frm);\r\n\tfrm.set_value(\"scan_data\", \"\");\r\n\tfrm.set_value(\"message\", \"\");\r\n});\r\n\r\nfrappe.ui.form.on(\"Marketplace Outbond Receipt\", \"marketplace_courier\", function(frm, cdt, cdn) { \r\n\tclear_fields(frm);\r\n\t$('[data-fieldname = scan_data]').select();\r\n});\r\n\r\nfrappe.ui.form.on(\"Marketplace Outbond Receipt\", \"btn_reset\", function(frm, cdt, cdn) { \r\n\tif (frm.doc.docstatus < 1){\r\n\t    frm.set_value(\"label_list\", \"\");\r\n\t    frm.set_value(\"total_package\", \"0\");\r\n\t    frm.set_value(\"scan_data\", \"\");\r\n\t    frm.set_value(\"message\", \"\");\r\n\t    $('[data-fieldname = scan_data]').select();\r\n\t}\r\n});\r\n\r\nfunction clear_fields (frm) {\r\n    frm.set_value(\"message\", \"\");frm.set_value(\"courier_name\", \"\");frm.set_value(\"courier_type\", \"\");\r\n    //frm.set_value(\"remarks\", \"\");\r\n}\r\nfrappe.ui.form.on(\"Marketplace Outbond Receipt\", \"update_delivery_status\", function(frm, order_no=\"\", awb_no=\"\") { \r\n    var awb_list;\r\n    if (!awb_no && !order_no)return;\r\n    if (!frm.doc.label_list)frm.doc.label_list = \"\";\r\n    \r\n    if (!awb_no && order_no)awb_no = order_no;\r\n    \r\n    if (frm.doc.label_list || !frm.doc.label_list) {\r\n        awb_list = frm.doc.label_list.trim().split(\"\\n\");\r\n        console.log('awb_list_array === ' + awb_list);\r\n        if (!awb_list.includes(awb_no) || !awb_list){\r\n            frm.set_value(\"label_list\",frm.doc.label_list + awb_no + \"\\n\");\r\n            frm.set_value(\"total_package\",awb_list.length || 0);\r\n            frm.set_value(\"message\",\"Success: \" + awb_no);\r\n        } else {\r\n            frm.set_value(\"message\",\"Failed double scan: \" + awb_no + \" already scanned\");\r\n            //frappe.msgprint(\"message\",\"Failed double scan: \" + frm.doc.scan_data.trim() + \" already scanned\");\r\n        }\r\n    }\r\n});\r\nfrappe.ui.form.on(\"Marketplace Outbond Receipt\", \"scan_data\", function(frm, cdt, cdn) { \r\n    clear_fields(frm);\r\n\tif (!frm.doc.scan_data)return;\r\n\t\r\n\tvar inv = \"\";\r\n\tfrappe.db.get_value(\"Sales Invoice\", {\"awb_no\":frm.doc.scan_data.trim(),\"is_return\":0, \"docstatus\":[\"<=\",2]}, [\"name\",\"customer\",\"order_status\",\"docstatus\",\"marketplace_courier\",\"courier\",\"awb_no\"], function(value){ \r\n\tconsole.log('value === ' + value);\r\n\tfrappe.db.get_value(\"Sales Invoice\", {\"no_online_order\":frm.doc.scan_data.trim(),\"is_return\":0,\"docstatus\":[\"<=\",2]}, [\"name\",\"customer\",\"order_status\",\"docstatus\",\"marketplace_courier\",\"courier\",\"awb_no\"], function(v){ \t\r\n\t\tconsole.log('v === ' + v);\r\n\t\tif (value === undefined || !value){\t\r\n\t\t\tif (v === undefined || !v){\r\n\t\t\t\tfrm.set_value(\"message\",\"Record not found!\");\r\n\t\t\t\t$('[data-fieldname = scan_data]').select(); return;\r\n\t\t\t}else value = v;\r\n\t\t}\r\n\t\t\r\n\t\tconsole.log('value.name === ' + value.name);\r\n\t\tconsole.log('value.awb_no === ' + value.awb_no);\r\n\t\tconsole.log('order_status == ' + value.order_status);\r\n\t\tconsole.log('docstatus == ' + value.docstatus);\r\n\t\tif (!value.awb_no){\r\n\t\t    frm.set_value(\"message\", value.name + \": AWB No not found, will be using valid Order No\");\r\n\t\t    //frappe.msgprint(value.name + \": AWB No not found, will be using Order No\");   \r\n\t\t    //return;\r\n\t\t}else if (frm.doc.customer && value.customer != frm.doc.customer && !frm.doc.ignore_courier_master_check){\r\n\t\t    frm.set_value(\"message\", \"Customer: \" + frm.doc.customer + \" doesn't match with \" + value.awb_no + \":\" + value.customer);\r\n\t\t    frappe.msgprint(\"Customer: \" + frm.doc.customer + \" doesn't match with \" + value.awb_no + \":\" + value.customer);   \r\n\t\t    return;\r\n\t\t}\r\n\t\t//if (value.marketplace_courier != frm.doc.marketplace_courier) {\r\n\t\t//    frm.set_value(\"message\",\"Courier from order doesn't match with master selection : \" + value.marketplace_courier);\r\n\t\t    //return;\r\n\t\t//}\r\n\t\tvar validate_courier = false;\r\n\t\t$.each(frm.doc.courier_references, function(i, d) {\r\n\t\t        if (d.marketplace_courier == value.marketplace_courier){\r\n\t\t            validate_courier = true; return;\r\n\t\t        }\r\n\t\t});\r\n\t\tif (frm.doc.ignore_courier_master_check)validate_courier = true;\r\n\t\t\r\n\t\tif (!validate_courier){\r\n\t\t    frm.set_value(\"message\", value.name + \"-\" + value.marketplace_courier + \" does not match any Courier Table in this receipt\");\r\n\t\t    frappe.msgprint(value.name + \"-\" + value.marketplace_courier + \" does not match any Courier Table in this receipt\");   \r\n\t\t    return;\r\n\t\t}\r\n\t\t\r\n\t\tif (value.name && value.docstatus <=1 && value.order_status != \"Completed\") {\r\n\t\t\tfrm.set_value(\"message\",\"Not Valid. Status \" + value.name + \": \" + value.order_status);\r\n\t\t} else if (value.docstatus == 1 && value.order_status == \"Delivered\") {\r\n\t\t\tfrm.set_value(\"message\",\"Not Valid. Status \" + value.name + \": \" + value.order_status);\r\n\t\t} else if (value.docstatus == 2) {\r\n\t\t\tfrm.set_value(\"message\",\"Not Valid. Status \" + value.name + \": Cancelled\");\r\n\t\t} else if (value.docstatus == 1 && value.order_status == \"Completed\") {\r\n\t\t    //console.log('doc.order_status == ' + value.order_status);\r\n\t\t    //frm.set_value(\"courier_name\", value.courier);\r\n\t\t    //frm.set_value(\"courier_type\", value.courier_type);\r\n\t\t    frm.events.update_delivery_status(frm, value.name, value.awb_no);\r\n\t\t    //frm.set_value(\"message\",\"Success: \" + value.name);\r\n\t\t} \r\n\t\t$('[data-fieldname = scan_data]').select();\r\n\t});\t\r\n}); \r\n});\r\n"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Pack Item",
  "modified": "2020-07-09 15:29:14.023591",
  "name": "Pack Item-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on(\"Pack Item\", \"onload_post_render\", function(frm, cdt, cdn) { \r\n\tif (!frm.doc.scan_start && !frm.doc.scan_end)$('[data-fieldname = scan_start]').select();\r\n});\r\nfrappe.ui.form.on(\"Pack Item\", \"refresh\", function(frm, cdt, cdn) { \r\n\tfrm.set_df_property(\"send_to_qc\",\"read_only\",frm.doc.total_rows ? 0 : 1);\r\n});\r\nfrappe.ui.form.on(\"Pack Item\", \"onload\", function(frm, cdt, cdn) { \r\n    $('[data-fieldname = scan_start]').focus().select();\r\n    //frm.set_value(\"send_to_qc\",1);\r\n\t//frm.trigger(\"load_unpicked_items\");\r\n\tconsole.log(\"Pack Item onload\");\r\n\tfrm.disable_save();\r\n});\r\nfrappe.ui.form.on(\"Pack Item\", \"create_log_table\", function(frm, cdt, cdn) { \r\n\tif (frm.doc.items_log) {\r\n\t    let msg = JSON.parse(frm.doc.items_log);\r\n\t    var $log_wrapper = $(frm.fields_dict.item_details.wrapper).empty();\r\n\t    console.log(\"render data table == \" + msg.messages);\r\n\t    $(frappe.render_template(\"item_details\", {\r\n\t\t    data: msg.messages\r\n\t    })).appendTo($log_wrapper);\r\n\t}\r\n});\r\nfrappe.ui.form.on(\"Pack Item\", \"load_item_details\", function(frm, cdt, cdn) { \r\n\treturn frm.call({\r\n\t\t\tdoc: frm.doc,\r\n\t\t\tmethod: \"load_item_details\",\r\n\t\t\tcallback: function(r) {\r\n\t\t\t\tif(!r.exc) {\r\n\t\t\t\t    console.log(\"frm.doc.items_log == \" + frm.doc.items_log);\r\n\t\t\t\t    if (frm.doc.items_log) {\r\n\t\t\t            frm.events.create_log_table(frm);\r\n\t\t            } else if (frm.doc.items_log !== undefined) {\r\n\t\t\t            $(frm.fields_dict.import_log.wrapper).empty();\r\n\t\t            }\r\n\t\t\t\t    refresh_field(\"item_details\");\r\n\t\t\t\t    if (frm.doc.type == \"Scan Start\") $('[data-fieldname = scan_start]').select();\r\n\t\t\t\t    else $('[data-fieldname = scan_end]').select();\r\n\t\t\t\t    frm.set_df_property(\"send_to_qc\",\"read_only\",frm.doc.total_rows ? 0 : 1);\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\terror: function(r) {\r\n\t\t\t\tconsole.log('error === ' + r);\r\n\t\t\t\tfrm.set_value(\"status\",\"Error: \" + r);\r\n\t\t\t\tif (frm.doc.type == \"Scan Start\") $('[data-fieldname = scan_start]').select();\r\n\t\t\t\telse $('[data-fieldname = scan_end]').select();\r\n\t\t\t\tfrm.set_df_property(\"send_to_qc\",\"read_only\",frm.doc.total_rows ? 0 : 1);\r\n\t\t\t}\r\n\t\t});\r\n});\r\nfunction clear_fields (frm) {\r\n    var $log_wrapper = $(frm.fields_dict.item_details.wrapper).empty();\r\n    frm.set_value(\"packing_start_time\", \"\");frm.set_value(\"packing_end_time\", \"\");\r\n    frm.set_value(\"status\", \"\");frm.set_value(\"total_rows\", \"0\");\r\n    frm.set_df_property(\"send_to_qc\",\"read_only\",1);\r\n}\r\nfrappe.ui.form.on(\"Pack Item\", \"send_to_qc\", function(frm, cdt, cdn) { \r\n\tif (frm.doc.total_rows) frm.events.load_item_details(frm);\r\n});\r\nfrappe.ui.form.on(\"Pack Item\", \"scan_start\", function(frm, cdt, cdn) { \r\n    clear_fields(frm);\r\n\tif (!frm.doc.scan_start)return;\r\n\telse {\r\n\t    frm.set_value(\"type\",\"Scan Start\");\r\n\t    frm.events.load_item_details(frm);\r\n\t}\r\n\t//frm.set_value(\"scan_serial_batch\", \"\");\r\n\t\r\n\t/* var inv = \"\";\r\n\tfrappe.db.get_value(\"Sales Invoice\", {\"name\":frm.doc.scan_awb_order.trim(),\"is_return\":0, \"docstatus\":[\"<\",2]}, [\"name\",\"awb_no\",\"docstatus\"], function(value){ \r\n\tconsole.log('value === ' + value);\r\n\tfrappe.db.get_value(\"Sales Invoice\", {\"awb_no\":frm.doc.scan_awb_order.trim(),\"is_return\":0,\"docstatus\":[\"<\",2]}, [\"name\",\"awb_no\",\"docstatus\"], function(v){ \t\r\n\t\tconsole.log('v === ' + v);\r\n\t\tif (value === undefined || !value){\t\r\n\t\t\tif (v === undefined || !v){\r\n\t\t\t\tfrm.set_value(\"status\",\"Order No / AWB not found!\");\r\n\t\t\t\t$('[data-fieldname = scan_awb_order]').select(); return;\r\n\t\t\t}else value = v;\r\n\t\t}\r\n\t\tconsole.log('value.name === ' + value.name);\r\n\t\tif (value.name && value.docstatus === 0) {\r\n\t\t    console.log('here..after scan awb')\r\n\t\t\tfrm.set_value(\"status\",\"\");\r\n\t\t\tfrm.set_value(\"scan_serial_batch\", \"\");\r\n\t\t\t$('[data-fieldname = scan_serial_batch]').select();\r\n\t\t} else if (value.docstatus == 1) {\r\n\t\t\tfrm.set_value(\"status\",\"Order No / AWB No was already delivered\");\r\n\t\t\t$('[data-fieldname = scan_awb_order]').select();\r\n\t\t} \r\n\t\tfrm.refresh_field(\"status\");\t\r\n\t});\t\r\n}); */\r\n});\r\n\r\nfrappe.ui.form.on(\"Pack Item\", \"scan_end\", function(frm, cdt, cdn) { \r\n\tclear_fields(frm);\r\n\tif (!frm.doc.scan_end)return;\r\n\telse {\r\n\t    console.log('frm.doc.scan_end === ' + frm.doc.scan_end);\r\n\t    frm.set_value(\"type\",\"Scan End\");\r\n\t    frm.events.load_item_details(frm);\r\n\t}\r\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Marketplace CSO",
  "modified": "2020-07-09 15:29:37.970242",
  "name": "Marketplace CSO-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "frappe.ui.form.on('Marketplace CSO', {\n\trefresh(frm) {\n\t\tif (in_list([\"Cancelled\", \"Completed\"], frm.doc.status)){\n\t\t    console.log('frm.doc.status = ' + frm.doc.status);\n\t\t    frm.disable_save();\n\t\t    frm.set_read_only();\n\t\t\tfrm.refresh_fields();\n\t\t}\n\t}\n});"
 },
 {
  "docstatus": 0,
  "doctype": "Custom Script",
  "dt": "Pick and Pack",
  "modified": "2020-07-09 15:30:02.417296",
  "name": "Pick and Pack-Client",
  "parent": null,
  "parentfield": null,
  "parenttype": null,
  "script": "var selected_device;\r\nvar devices = [];\r\nfunction writeToSelectedPrinter(dataToWrite)\r\n{\r\n\tselected_device.send(dataToWrite, undefined, errorCallback);\r\n}\r\nvar readCallback = function(readData) {\r\n\tif(readData === undefined || readData === null || readData === \"\")\r\n\t{\r\n\t\talert(\"No Response from Device\");\r\n\t}\r\n\telse\r\n\t{\r\n\t\talert(readData);\r\n\t}\r\n\t\r\n}\r\nvar errorCallback = function(errorMessage){\r\n\talert(\"Error: \" + errorMessage);\t\r\n}\r\nfunction browser_print_setup(frm)\r\n{\r\n\t//Get the default device from the application as a first step. Discovery takes longer to complete.\r\n\tBrowserPrint.getDefaultDevice(\"printer\", function(device)\r\n\t\t\t{\r\n\t\t\r\n\t\t\t\t//Add device to list of devices and to html select element\r\n\t\t\t\tselected_device = device;\r\n\t\t\t\tdevices.push(device);\r\n\t\t\t\t//var html_select = document.getElementById(\"selected_device\");\r\n\t\t\t\t//var option = document.createElement(\"option\");\r\n\t\t\t\t//option.text = device.name;\r\n\t\t\t\t//html_select.add(option);\r\n\t\t\t\tfrm.set_value(\"printer_name\",device.name);\r\n\t\t\t\t\r\n\t\t\t\t//Discover any other devices available to the application\r\n\t\t\t\tBrowserPrint.getLocalDevices(function(device_list){\r\n\t\t\t\t\tfor(var i = 0; i < device_list.length; i++)\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\t//Add device to list of devices and to html select element\r\n\t\t\t\t\t\tvar device = device_list[i];\r\n\t\t\t\t\t\tif(!selected_device || device.uid != selected_device.uid)\r\n\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\tdevices.push(device);\r\n\t\t\t\t\t\t\t//var option = document.createElement(\"option\");\r\n\t\t\t\t\t\t\t//option.text = device.name;\r\n\t\t\t\t\t\t\t//option.value = device.uid;\r\n\t\t\t\t\t\t\t//html_select.add(option);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t\t\r\n\t\t\t\t}, function(){alert(\"Error getting local devices\")},\"printer\");\r\n\t\t\t\t\r\n\t\t\t}, function(error){\r\n\t\t\t\talert(error);\r\n\t\t\t})\r\n}\r\n\r\nfunction play_sound(){\r\n\tvar audio = new Audio('/files/buzz.mp3');\r\n\taudio.loop = false;\r\n\taudio.play(); \r\n}\r\nfrappe.ui.form.on(\"Pick and Pack\", \"print\", function(frm, cdt, cdn) { \r\n\tif (frm.doc.awb_no && frm.doc.printer_name){\r\n\t\twriteToSelectedPrinter(frm.doc.zpl_start+frm.doc.awb_no+frm.doc.zpl_end);\r\n\t}\r\n});\r\nfrappe.ui.form.on(\"Pick and Pack\", \"onload_post_render\", function(frm, cdt, cdn) { \r\n\tif (!frm.doc.search)$('[data-fieldname = scan_awb_barcode]').focus();\r\n});\r\nfrappe.ui.form.on(\"Pick and Pack\", \"refresh\", function(frm, cdt, cdn) { \r\n\t//$('document').on('click', function(e){ console.log('OK'); });\r\n\tif (!frm.doc.search)$('[data-fieldname = scan_awb_barcode]').focus();\r\n\tfrm.set_value(\"status\",\"\");\r\n\tfrm.set_df_property(\"print\",\"hidden\",frm.doc.awb_no ? 0 : 1);\r\n\tfrm.set_query(\"search\", function(){\r\n        \treturn {\r\n\t\t            \"filters\": [\r\n                \t\t\t[\"docstatus\", \"=\", 0],\r\n\t\t\t\t\t[\"is_return\", \"=\", 0]\r\n            \t\t\t]\r\n        \t}\r\n    \t});\r\n});\r\nfrappe.ui.form.on(\"Pick and Pack\", \"awb_no\", function(frm, cdt, cdn) { \r\n\tfrm.set_df_property(\"print\",\"hidden\",frm.doc.awb_no ? 0 : 1);\r\n\tif (frm.doc.awb_no && frm.doc.search){\r\n\t\t//frappe.db.set_value(\"Sales Invoice\", frm.doc.search, \"awb_no\", frm.doc.awb_no);\r\n\t\tfrappe.db.set_value(\"Sales Invoice\", frm.doc.search, \"awb_no\", frm.doc.awb_no, function(r){\r\n\t\t\tfrm.set_value(\"awb_status\",\"AWB updated : \" + frm.doc.awb_no);\r\n\t\t\t$('[data-fieldname = scan_awb_barcode]').focus().select();\r\n\t\t\tfrm.doc.awb_no = \"\";frm.refresh_field(\"awb_no\");\r\n\t\t});\r\n\t}\r\n});\r\nfrappe.ui.form.on(\"Pick and Pack\", \"search\", function(frm, cdt, cdn) {\r\n\tfrm.set_value(\"awb_status\",\"\");\r\n\tfrm.doc.awb_no = \"\";frm.refresh_field(\"awb_no\"); \r\n\tfrm.set_df_property(\"print\",\"hidden\",frm.doc.awb_no ? 0 : 1);\r\n\tfrappe.db.get_value(\"Sales Invoice\", {\"name\":frm.doc.search,\"docstatus\":0,\"is_return\":0}, [\"awb_no\"], function(value){ \r\n\t\tconsole.log('get awb === ' + value.awb_no);\r\n\t\tif (value.awb_no){\r\n\t\t\tfrm.doc.awb_no = value.awb_no;frm.refresh_field(\"awb_no\");\r\n\t\t\tfrm.set_df_property(\"awb_no\",\"read_only\",1);\r\n\t\t\t$('[data-fieldname = search]').focus().select();\r\n\t\t}else {\r\n\t\t\tfrm.set_df_property(\"awb_no\",\"read_only\",0);\r\n\t\t\t$('[data-fieldname = awb_no]').focus().select();\r\n\t\t}\r\n\t});\r\n});\r\nfrappe.ui.form.on(\"Pick and Pack\", \"onload\", function(frm, cdt, cdn) { \r\n\t//console.log(frappe.get_doc('Item', 'PRN17AB'));\r\n\t//console.log(frappe.get_doc('Sales Invoice','181095347142-01'));\r\n\t\r\n\t//browser_print_setup(frm);\r\n\tfrm.disable_save();\r\n\t$('[data-fieldname = scan_awb_barcode]').focus();\r\n});\r\nfrappe.ui.form.on(\"Pick and Pack\", \"scan_awb_barcode\", function(frm, cdt, cdn) { \r\n\tif (!frm.doc.scan_awb_barcode)return;\r\n\t$(frm.fields_dict['status'].wrapper).html(\"\");\r\n\tvar inv = \"\";\r\n\t//frappe.utils.play_sound(\"salarm\");\r\n\tfrappe.db.get_value(\"Sales Invoice\", {\"awb_no\":frm.doc.scan_awb_barcode,\"is_return\":0, \"docstatus\":[\"<\",2]}, [\"name\",\"picked_and_packed\",\"title\",\"docstatus\"], function(value){ \r\n\tconsole.log('value === ' + value);\r\n\tfrappe.db.get_value(\"Sales Invoice\", {\"name\":frm.doc.scan_awb_barcode,\"is_return\":0,\"docstatus\":[\"<\",2]}, [\"name\",\"picked_and_packed\",\"title\",\"docstatus\"], function(v){ \t\r\n\t\tconsole.log('v === ' + v);\r\n\t\tif (value == undefined || !value){\t\r\n\t\t\tif (v == undefined || !v){\r\n\t\t\t\tplay_sound();\r\n\t\t\t\t$(frm.fields_dict['status'].wrapper).html(\"<h2 style='color: red; background-color: #f5f7fa;'>TIDAK DITEMUKAN - \" + frm.doc.scan_awb_barcode + \"</h2>\");\r\n\t\t\t\tfrm.refresh_field(\"status\");\r\n\t\t\t\tfrm.set_value(\"scan_awb_barcode\",\"\");\r\n\t\t\t\tfrm.set_value(\"order_id\",\"\");\r\n\t\t\t\treturn;\r\n\t\t\t}else value = v;\r\n\t\t}\r\n\t\tconsole.log('value.name === ' + value.name);\r\n\t\tconsole.log('value.docstatus === ' + value.docstatus);\r\n\t\tif (value.name && value.docstatus == 0) {\r\n\t\t\tinv = value.name;\r\n\t\t\t//invo = frappe.get_doc('Sales Invoice',value.name);\r\n\t\t\t//console.log(frappe.get_doc('Sales Invoice',value.name));\r\n\t\t\t\r\n\t\t\tfrappe.call({\r\n\t\t\t\tmethod: \"custom1.custom1.custom1.submit_awb_invoice\", \r\n\t\t\t\targs: {\r\n\t\t\t\t\t\"ref_no\" : value.name //{\"doctype\": \"Sales Invoice\", \"docname\": value.name}\r\n\t\t\t\t},\r\n\t\t\t\tcallback: function(r) {\r\n\t\t\t\t\t/* frappe.db.set_value(\"Sales Invoice\", inv, \"title\", \"[PnP] \"+value.title, function(r){\r\n\t\t\t\t\t\tfrappe.db.set_value(\"Sales Invoice\", inv, \"picked_and_packed\", \"1\");\r\n\t\t\t\t\t});*/\r\n\t\t\t\t\tconsole.log('here callback calling submit invoice');\r\n\t\t\t\t\tfrm.set_value(\"order_id\",value.name);\r\n\t\t\t\t\t$(frm.fields_dict['status'].wrapper).html(\"<h2 style='color: green; background-color: #f5f7fa;'>SUCCESS - \" + frm.doc.scan_awb_barcode + \"</h2>\");\t\t\t\t\t\r\n\t\t\t\t\tfrm.set_value(\"scan_awb_barcode\",\"\");\r\n\t\t\t\t\t$('[data-fieldname = scan_awb_barcode]').focus();return;\r\n\t\t\t\t},\r\n\t\t\t\terror: function(r) {\r\n\t\t\t\t\tconsole.log('error submit inv === ' + r);\r\n\t\t\t\t\tplay_sound();\r\n\t\t\t\t\tfrm.set_value(\"scan_awb_barcode\",\"\");\r\n\t\t\t\t\t$('[data-fieldname = scan_awb_barcode]').focus();\r\n\t\t\t\t\t$(this).focus();  \r\n\t\t\t\t\t//frm.refresh();\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t} else if (value.picked_and_packed || value.docstatus >= 1) {\r\n\t\t\tplay_sound();\r\n\t\t\tfrm.set_value(\"order_id\",value.name);\r\n\t\t\t$(frm.fields_dict['status'].wrapper).html(\"<h2 style='color: red; background-color: #f5f7fa;'>DITOLAK. \" + frm.doc.scan_awb_barcode + \" - Sudah Pernah Keluar!</h2>\");\r\n\t\t\tfrm.refresh_field(\"status\");\r\n\t\t\tfrm.set_value(\"scan_awb_barcode\",\"\");\r\n\t\t\t$('[data-fieldname = scan_awb_barcode]').focus();\r\n\t\t} \t\r\n\t});\t\r\n});\r\n\t\r\n\t$('[data-fieldname = scan_awb_barcode]').focus();\t\r\n});\r\n/*\r\n\t\t\tfrappe.call({\r\n        \t   \t\t\"method\": \"frappe.client.set_value\",\r\n\t\t\t\t\"args\": {\r\n\t\t\t      \t\t\t\"doctype\": \"Sales Invoice\",\r\n\t               \t\t\t\t\"name\": inv,\r\n\t\t\t       \t\t        \"fieldname\": \"picked_and_packed\",\r\n        \t        \t\t\t\"value\": 1\r\n            \t\t\t}\t\r\n        \t\t});\r\n\t\t\t*/"
 }
]